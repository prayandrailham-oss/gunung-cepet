-- ============================================================
-- WORDHELPER V4 - SAMBUNG KATA EDITION
-- Based on Last Letter script, modified for Sambung Kata:
--   - URL kamus diganti ke KBBI Indonesia
--   - GetCurrentGameWord() -> baca WordSubmit (sort by X)
--   - GetTurnInfo() -> cek Word labels di WordSubmit
--   - GetGameTextBox() -> path MatchUI Sambung Kata
--   - SmartType() -> lanjut dari kata yang sudah diketik
-- ============================================================

local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")
local Players = game:GetService("Players")

local cloneref = cloneref or function(o) return o end
local gethui = gethui or function() return CoreGui end

local CoreGui = cloneref(game:GetService("CoreGui"))
local Players = cloneref(game:GetService("Players"))
local VirtualInputManager = cloneref(game:GetService("VirtualInputManager"))
local UserInputService = cloneref(game:GetService("UserInputService"))
local RunService = cloneref(game:GetService("RunService"))
local TweenService = cloneref(game:GetService("TweenService"))
local GuiService = cloneref(game:GetService("GuiService"))

local request = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request

local TOGGLE_KEY = Enum.KeyCode.RightControl
local MIN_CPM = 50
local MAX_CPM_LEGIT = 1500
local MAX_CPM_BLATANT = 3000

math.randomseed(os.time())

local THEME = {
    Background = Color3.fromRGB(20, 20, 24),
    ItemBG = Color3.fromRGB(32, 32, 38),
    Accent = Color3.fromRGB(114, 100, 255),
    Text = Color3.fromRGB(240, 240, 240),
    SubText = Color3.fromRGB(150, 150, 160),
    Success = Color3.fromRGB(100, 255, 140),
    Warning = Color3.fromRGB(255, 200, 80),
    Slider = Color3.fromRGB(60, 60, 70)
}

local function ColorToRGB(c)
    return string.format("%d,%d,%d", math.floor(c.R * 255), math.floor(c.G * 255), math.floor(c.B * 255))
end

local ConfigFile = "WordHelper_SK_Config.json"
local Config = {
    CPM = 550,
    Blatant = false,
    Humanize = true,
    FingerModel = true,
    SortMode = "Random",
    SuffixMode = "",
    LengthMode = 0,
    AutoPlay = false,
    PanicMode = true,
    ShowKeyboard = false,
    ErrorRate = 5,
    ThinkDelay = 0.8,
    RiskyMistakes = false,
    CustomWords = {},
    MinWordLength = 3,
    KeyboardLayout = "QWERTY"
}

local function SaveConfig()
    if writefile then
        writefile(ConfigFile, HttpService:JSONEncode(Config))
    end
end

local function LoadConfig()
    if isfile and isfile(ConfigFile) then
        local success, decoded = pcall(function() return HttpService:JSONDecode(readfile(ConfigFile)) end)
        if success and decoded then
            for k, v in pairs(decoded) do Config[k] = v end
        end
    end
end
LoadConfig()

local currentCPM = Config.CPM
local isBlatant = Config.Blatant
local useHumanization = Config.Humanize
local useFingerModel = Config.FingerModel
local sortMode = Config.SortMode
local suffixMode = Config.SuffixMode or ""
local lengthMode = Config.LengthMode or 0
local autoPlay = Config.AutoPlay
local panicMode = Config.PanicMode
local showKeyboard = Config.ShowKeyboard
local errorRate = Config.ErrorRate
local thinkDelayCurrent = Config.ThinkDelay
local riskyMistakes = Config.RiskyMistakes
local keyboardLayout = Config.KeyboardLayout or "QWERTY"
local minWordLength = Config.MinWordLength or 3

local isTyping = false
local isAutoPlayScheduled = false
local lastTypingStart = 0
local runConn = nil
local inputConn = nil
local unloaded = false
local Blacklist = {}
local UsedWords = {}
local RandomOrderCache = {}
local RandomPriority = {}
local lastDetected = "---"
local lastLogicUpdate = 0
local lastWordCheck = 0
local cachedDetected = ""
local LOGIC_RATE = 0.1
local UpdateList
local ButtonCache = {}
local ButtonData = {}
local thinkDelayMin = 0.4
local thinkDelayMax = 1.2

local listUpdatePending = false
local forceUpdateList = false
local lastInputTime = 0
local LIST_DEBOUNCE = 0.05
local currentBestMatch = nil

-- ============================================================
-- [SAMBUNG KATA] PATH HELPERS
-- ============================================================
local function GetMatchUI()
    local gui = Players.LocalPlayer and Players.LocalPlayer:FindFirstChild("PlayerGui")
    return gui and gui:FindFirstChild("MatchUI")
end

local function GetBottomUI()
    local m = GetMatchUI()
    return m and m:FindFirstChild("BottomUI")
end

local function GetTopUI()
    local b = GetBottomUI()
    return b and b:FindFirstChild("TopUI")
end

local function GetWordSubmit()
    local t = GetTopUI()
    return t and t:FindFirstChild("WordSubmit")
end

-- [GANTI] Baca kata yang sedang diketik dari WordSubmit, sort by posisi X
local function GetCurrentGameWord()
    local wordSubmit = GetWordSubmit()
    if not wordSubmit then return "", false end

    local letters = {}
    for _, v in ipairs(wordSubmit:GetChildren()) do
        if v:IsA("TextLabel") and v.Name == "Word" and v.Visible and v.Text ~= "" then
            table.insert(letters, {text = v.Text, x = v.AbsolutePosition.X})
        end
    end

    -- Sort dari kiri ke kanan (X terkecil = huruf paling kiri)
    table.sort(letters, function(a, b) return a.x < b.x end)

    local result = ""
    for _, l in ipairs(letters) do result = result .. l.text end
    return result:lower(), false
end

-- [GANTI] Cek giliran via ada/tidaknya Word label berisi teks di WordSubmit
-- Giliran kamu  → ada Word label visible dan berisi teks
-- Giliran musuh → tidak ada Word label berisi teks
local function GetTurnInfo()
    local wordSubmit = GetWordSubmit()
    if not wordSubmit then return false, nil end

    local letters = {}
    for _, v in ipairs(wordSubmit:GetChildren()) do
        if v:IsA("TextLabel") and v.Name == "Word" and v.Visible and v.Text ~= "" then
            table.insert(letters, {text = v.Text, x = v.AbsolutePosition.X})
        end
    end

    if #letters == 0 then return false, nil end

    -- Ambil huruf wajib dari WordServer (huruf awal dari game)
    local topUI = GetTopUI()
    local wsf = topUI and topUI:FindFirstChild("WordServerFrame")
    local ws  = wsf and wsf:FindFirstChild("WordServer")
    local reqLetter = nil
    if ws and ws:IsA("TextLabel") then
        reqLetter = ws.Text:lower():gsub("[%s%c]+", "")
        if #reqLetter == 0 then reqLetter = nil end
    end

    return true, reqLetter
end

-- Cek apakah sedang dalam ronde aktif
local function IsInRound()
    local topUI = GetTopUI()
    local wsf = topUI and topUI:FindFirstChild("WordServerFrame")
    local ws  = wsf and wsf:FindFirstChild("WordServer")
    if ws and ws:IsA("TextLabel") then
        local txt = ws.Text:lower():gsub("[%s%c]+", "")
        return #txt > 0
    end
    return false
end

-- Ambil nilai timer
local function GetTimer()
    local b = GetBottomUI()
    local c  = b and b:FindFirstChild("CenterUI")
    local th = c and c:FindFirstChild("TimerHealthUI")
    local tu = th and th:FindFirstChild("TimerUI")
    local tl = tu and tu:FindFirstChild("Timer")
    if tl and tl:IsA("TextLabel") then
        return tonumber(tl.Text:match("([%d%.]+)"))
    end
    return nil
end

-- [GANTI] Cari TextBox di MatchUI Sambung Kata
local function GetGameTextBox()
    local topUI = GetTopUI()
    local keyboard = topUI and topUI:FindFirstChild("Keyboard")
    if keyboard then
        for _, c in ipairs(keyboard:GetDescendants()) do
            if c:IsA("TextBox") and c.Visible then return c end
        end
    end
    local matchUI = GetMatchUI()
    if matchUI then
        for _, c in ipairs(matchUI:GetDescendants()) do
            if c:IsA("TextBox") and c.Visible then return c end
        end
    end
    return UserInputService:GetFocusedTextBox()
end

-- ============================================================
-- [GANTI] URL KAMUS KE INDONESIA (KBBI)
-- ============================================================
local url = "https://raw.githubusercontent.com/geovedi/indonesian-wordlist/master/01-kbbi3-2001-sort-alpha.lst"
local fileName = "ultimate_words_sk_v4.txt"

-- Temporary Loading UI
local LoadingGui = Instance.new("ScreenGui")
LoadingGui.Name = "WordHelperLoading"
local success, parent = pcall(function() return gethui() end)
if not success or not parent then parent = game:GetService("CoreGui") end
LoadingGui.Parent = parent
LoadingGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local LoadingFrame = Instance.new("Frame", LoadingGui)
LoadingFrame.Size = UDim2.new(0, 300, 0, 100)
LoadingFrame.Position = UDim2.new(0.5, -150, 0.4, 0)
LoadingFrame.BackgroundColor3 = THEME.Background
LoadingFrame.BorderSizePixel = 0
Instance.new("UICorner", LoadingFrame).CornerRadius = UDim.new(0, 10)
local LStroke = Instance.new("UIStroke", LoadingFrame)
LStroke.Color = THEME.Accent
LStroke.Transparency = 0.5
LStroke.Thickness = 2

local LoadingTitle = Instance.new("TextLabel", LoadingFrame)
LoadingTitle.Size = UDim2.new(1, 0, 0, 40)
LoadingTitle.BackgroundTransparency = 1
LoadingTitle.Text = "WordHelper — Sambung Kata"
LoadingTitle.TextColor3 = THEME.Accent
LoadingTitle.Font = Enum.Font.GothamBold
LoadingTitle.TextSize = 18

local LoadingStatus = Instance.new("TextLabel", LoadingFrame)
LoadingStatus.Size = UDim2.new(1, -20, 0, 30)
LoadingStatus.Position = UDim2.new(0, 10, 0, 50)
LoadingStatus.BackgroundTransparency = 1
LoadingStatus.Text = "Initializing..."
LoadingStatus.TextColor3 = THEME.Text
LoadingStatus.Font = Enum.Font.Gotham
LoadingStatus.TextSize = 14

local function UpdateStatus(text, color)
    LoadingStatus.Text = text
    if color then LoadingStatus.TextColor3 = color end
    game:GetService("RunService").RenderStepped:Wait()
end

local function FetchWords()
    UpdateStatus("Mengunduh daftar kata KBBI...", THEME.Warning)
    local success, res = pcall(function()
        return request({Url = url, Method = "GET"})
    end)
    if success and res and res.Body then
        writefile(fileName, res.Body)
        UpdateStatus("Berhasil diunduh!", THEME.Success)
    else
        UpdateStatus("Gagal unduh, pakai cache.", Color3.fromRGB(255, 80, 80))
    end
    task.wait(0.5)
end

FetchWords()

local Words = {}
local SeenWords = {}

local function LoadList(fname)
    UpdateStatus("Memuat daftar kata...", THEME.Warning)
    if isfile(fname) then
        local content = readfile(fname)
        for w in content:gmatch("[^\r\n]+") do
            local clean = w:gsub("[%s%c]+", ""):lower()
            if #clean >= minWordLength and not SeenWords[clean] then
                SeenWords[clean] = true
                table.insert(Words, clean)
            end
        end
        UpdateStatus("Dimuat " .. #Words .. " kata!", THEME.Success)
    else
        UpdateStatus("File tidak ditemukan!", Color3.fromRGB(255, 80, 80))
    end
    task.wait(1)
end

LoadList(fileName)

if LoadingGui then LoadingGui:Destroy() end

table.sort(Words)
Buckets = {}
for _, w in ipairs(Words) do
    local c = w:sub(1,1) or ""
    if c == "" then c = "#" end
    Buckets[c] = Buckets[c] or {}
    table.insert(Buckets[c], w)
end

if Config.CustomWords then
    for _, w in ipairs(Config.CustomWords) do
        local clean = w:gsub("[%s%c]+", ""):lower()
        if #clean > 0 and not SeenWords[clean] then
            SeenWords[clean] = true
            table.insert(Words, clean)
            local c = clean:sub(1,1) or ""
            if c == "" then c = "#" end
            Buckets[c] = Buckets[c] or {}
            table.insert(Buckets[c], clean)
        end
    end
end

SeenWords = nil

local function shuffleTable(t)
    local n = #t
    for i = n, 2, -1 do
        local j = math.random(i)
        t[i], t[j] = t[j], t[i]
    end
    return t
end

local HardLetterScores = {
    x = 10, z = 9, q = 9, j = 8, v = 6, k = 5, b = 4, f = 3, w = 3,
    y = 2, g = 2, p = 2
}

local function GetKillerScore(word)
    local lastChar = word:sub(-1)
    return HardLetterScores[lastChar] or 0
end

local function Tween(obj, props, time)
    TweenService:Create(obj, TweenInfo.new(time or 0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), props):Play()
end

local function GetSecureParent()
    local success, result = pcall(function() return gethui() end)
    if success and result then return result end
    success, result = pcall(function() return CoreGui end)
    if success and result then return result end
    return Players.LocalPlayer.PlayerGui
end

local ParentTarget = GetSecureParent()
local GuiName = tostring(math.random(1000000, 9999999))

local env = (getgenv and getgenv()) or _G
if env.WordHelperInstance and env.WordHelperInstance.Parent then
    env.WordHelperInstance:Destroy()
end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = GuiName
ScreenGui.Parent = ParentTarget
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
env.WordHelperInstance = ScreenGui

local ToastContainer = Instance.new("Frame", ScreenGui)
ToastContainer.Name = "ToastContainer"
ToastContainer.Size = UDim2.new(0, 300, 1, 0)
ToastContainer.Position = UDim2.new(1, -320, 0, 20)
ToastContainer.BackgroundTransparency = 1
ToastContainer.ZIndex = 100

local function ShowToast(message, type)
    local toast = Instance.new("Frame")
    toast.Size = UDim2.new(1, 0, 0, 40)
    toast.BackgroundColor3 = THEME.ItemBG
    toast.BorderSizePixel = 0
    toast.BackgroundTransparency = 1
    toast.Parent = ToastContainer
    local stroke = Instance.new("UIStroke", toast)
    stroke.Thickness = 1.5
    stroke.Transparency = 1
    local color = THEME.Text
    if type == "success" then color = THEME.Success
    elseif type == "warning" then color = THEME.Warning
    elseif type == "error" then color = Color3.fromRGB(255, 80, 80) end
    stroke.Color = color
    Instance.new("UICorner", toast).CornerRadius = UDim.new(0, 6)
    local lbl = Instance.new("TextLabel", toast)
    lbl.Size = UDim2.new(1, -20, 1, 0)
    lbl.Position = UDim2.new(0, 10, 0, 0)
    lbl.BackgroundTransparency = 1
    lbl.Text = message
    lbl.TextColor3 = color
    lbl.Font = Enum.Font.GothamMedium
    lbl.TextSize = 14
    lbl.TextWrapped = true
    lbl.TextTransparency = 1
    Tween(toast, {BackgroundTransparency = 0.1}, 0.3)
    Tween(lbl, {TextTransparency = 0}, 0.3)
    Tween(stroke, {Transparency = 0.2}, 0.3)
    task.delay(3, function()
        if toast and toast.Parent then
            Tween(toast, {BackgroundTransparency = 1}, 0.5)
            Tween(lbl, {TextTransparency = 1}, 0.5)
            Tween(stroke, {Transparency = 1}, 0.5)
            task.wait(0.5)
            toast:Destroy()
        end
    end)
end

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 300, 0, 500)
MainFrame.Position = UDim2.new(0.8, -50, 0.4, 0)
MainFrame.BackgroundColor3 = THEME.Background
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.ClipsDescendants = true
MainFrame.Parent = ScreenGui

local function EnableDragging(frame)
    local dragging, dragInput, dragStart, startPos
    local function Update(input)
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then Update(input) end
    end)
end

EnableDragging(MainFrame)

Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)
local Stroke = Instance.new("UIStroke", MainFrame)
Stroke.Color = THEME.Accent
Stroke.Transparency = 0.5
Stroke.Thickness = 2

local Header = Instance.new("Frame", MainFrame)
Header.Size = UDim2.new(1, 0, 0, 45)
Header.BackgroundColor3 = THEME.ItemBG
Header.BorderSizePixel = 0

local Title = Instance.new("TextLabel", Header)
Title.Text = "Word<font color=\"rgb(114,100,255)\">Helper</font> — Sambung Kata"
Title.RichText = true
Title.Font = Enum.Font.GothamBold
Title.TextSize = 16
Title.TextColor3 = THEME.Text
Title.Size = UDim2.new(1, -95, 1, 0)
Title.Position = UDim2.new(0, 15, 0, 0)
Title.BackgroundTransparency = 1
Title.TextXAlignment = Enum.TextXAlignment.Left

local MinBtn = Instance.new("TextButton", Header)
MinBtn.Text = "-"
MinBtn.Font = Enum.Font.GothamBold
MinBtn.TextSize = 24
MinBtn.TextColor3 = THEME.SubText
MinBtn.Size = UDim2.new(0, 45, 1, 0)
MinBtn.Position = UDim2.new(1, -90, 0, 0)
MinBtn.BackgroundTransparency = 1

local CloseBtn = Instance.new("TextButton", Header)
CloseBtn.Text = "X"
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.TextSize = 18
CloseBtn.TextColor3 = Color3.fromRGB(255, 80, 80)
CloseBtn.Size = UDim2.new(0, 45, 1, 0)
CloseBtn.Position = UDim2.new(1, -45, 0, 0)
CloseBtn.BackgroundTransparency = 1

CloseBtn.MouseButton1Click:Connect(function()
    unloaded = true
    if runConn then runConn:Disconnect() runConn = nil end
    if inputConn then inputConn:Disconnect() inputConn = nil end
    for _, btn in ipairs(ButtonCache) do btn:Destroy() end
    table.clear(ButtonCache)
    if ScreenGui and ScreenGui.Parent then ScreenGui:Destroy() end
end)

local StatusFrame = Instance.new("Frame", MainFrame)
StatusFrame.Size = UDim2.new(1, -30, 0, 24)
StatusFrame.Position = UDim2.new(0, 15, 0, 55)
StatusFrame.BackgroundTransparency = 1

local StatusDot = Instance.new("Frame", StatusFrame)
StatusDot.Size = UDim2.new(0, 8, 0, 8)
StatusDot.Position = UDim2.new(0, 0, 0.5, -4)
StatusDot.BackgroundColor3 = THEME.SubText
Instance.new("UICorner", StatusDot).CornerRadius = UDim.new(1, 0)

local StatusText = Instance.new("TextLabel", StatusFrame)
StatusText.Text = "Idle..."
StatusText.RichText = true
StatusText.Font = Enum.Font.Gotham
StatusText.TextSize = 12
StatusText.TextColor3 = THEME.SubText
StatusText.Size = UDim2.new(1, -15, 1, 0)
StatusText.Position = UDim2.new(0, 15, 0, 0)
StatusText.BackgroundTransparency = 1
StatusText.TextXAlignment = Enum.TextXAlignment.Left

local SearchFrame = Instance.new("Frame", MainFrame)
SearchFrame.Size = UDim2.new(1, -10, 0, 26)
SearchFrame.Position = UDim2.new(0, 5, 0, 82)
SearchFrame.BackgroundColor3 = THEME.ItemBG
Instance.new("UICorner", SearchFrame).CornerRadius = UDim.new(0, 6)

local SearchBox = Instance.new("TextBox", SearchFrame)
SearchBox.Size = UDim2.new(1, -20, 1, 0)
SearchBox.Position = UDim2.new(0, 10, 0, 0)
SearchBox.BackgroundTransparency = 1
SearchBox.Font = Enum.Font.Gotham
SearchBox.TextSize = 14
SearchBox.TextColor3 = THEME.Text
SearchBox.PlaceholderText = "Cari kata..."
SearchBox.PlaceholderColor3 = THEME.SubText
SearchBox.Text = ""
SearchBox.TextXAlignment = Enum.TextXAlignment.Left

local lastRequiredLetter = ""

SearchBox:GetPropertyChangedSignal("Text"):Connect(function()
    if UpdateList then
        UpdateList(lastDetected, lastRequiredLetter)
    end
end)

local ScrollList = Instance.new("ScrollingFrame", MainFrame)
ScrollList.Size = UDim2.new(1, -10, 1, -220)
ScrollList.Position = UDim2.new(0, 5, 0, 115)
ScrollList.BackgroundTransparency = 1
ScrollList.ScrollBarThickness = 3
ScrollList.ScrollBarImageColor3 = THEME.Accent
ScrollList.CanvasSize = UDim2.new(0,0,0,0)

local UIListLayout = Instance.new("UIListLayout", ScrollList)
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 4)

local SettingsFrame = Instance.new("Frame", MainFrame)
SettingsFrame.BackgroundColor3 = THEME.ItemBG
SettingsFrame.BorderSizePixel = 0
SettingsFrame.ClipsDescendants = true

local SlidersFrame = Instance.new("Frame", SettingsFrame)
SlidersFrame.Size = UDim2.new(1, 0, 0, 125)
SlidersFrame.BackgroundTransparency = 1

local TogglesFrame = Instance.new("Frame", SettingsFrame)
TogglesFrame.Size = UDim2.new(1, 0, 0, 280)
TogglesFrame.Position = UDim2.new(0, 0, 0, 125)
TogglesFrame.BackgroundTransparency = 1
TogglesFrame.Visible = false

local sep = Instance.new("Frame", SettingsFrame)
sep.Size = UDim2.new(1, 0, 0, 1)
sep.BackgroundColor3 = Color3.fromRGB(45, 45, 50)

local settingsCollapsed = true
local function UpdateLayout()
    if settingsCollapsed then
        Tween(SettingsFrame, {Size = UDim2.new(1, 0, 0, 125), Position = UDim2.new(0, 0, 1, -125)})
        Tween(ScrollList, {Size = UDim2.new(1, -10, 1, -245)})
        TogglesFrame.Visible = false
    else
        Tween(SettingsFrame, {Size = UDim2.new(1, 0, 0, 405), Position = UDim2.new(0, 0, 1, -405)})
        Tween(ScrollList, {Size = UDim2.new(1, -10, 1, -525)})
        TogglesFrame.Visible = true
    end
end
UpdateLayout()

local ExpandBtn = Instance.new("TextButton", SlidersFrame)
ExpandBtn.Text = "v Show Settings v"
ExpandBtn.Font = Enum.Font.GothamBold
ExpandBtn.TextSize = 14
ExpandBtn.TextColor3 = THEME.Accent
ExpandBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
ExpandBtn.BackgroundTransparency = 0.5
ExpandBtn.Size = UDim2.new(1, -10, 0, 30)
ExpandBtn.Position = UDim2.new(0, 5, 1, -35)
Instance.new("UICorner", ExpandBtn).CornerRadius = UDim.new(0, 6)

ExpandBtn.MouseButton1Click:Connect(function()
    settingsCollapsed = not settingsCollapsed
    ExpandBtn.Text = settingsCollapsed and "v Show Settings v" or "^ Hide Settings ^"
    UpdateLayout()
end)

local function SetupSlider(btn, bg, fill, callback)
    btn.MouseButton1Down:Connect(function()
        local move, rel
        local function Update()
            local mousePos = UserInputService:GetMouseLocation()
            local relX = math.clamp(mousePos.X - bg.AbsolutePosition.X, 0, bg.AbsoluteSize.X)
            local pct = relX / bg.AbsoluteSize.X
            callback(pct)
            Config.CPM = currentCPM
            Config.ErrorRate = errorRate
            Config.ThinkDelay = thinkDelayCurrent
        end
        Update()
        move = RunService.RenderStepped:Connect(Update)
        rel = UserInputService.InputEnded:Connect(function(inp)
            if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
                if move then move:Disconnect() move = nil end
                if rel then rel:Disconnect() rel = nil end
                SaveConfig()
            end
        end)
    end)
end

local KeyboardFrame = Instance.new("Frame", ScreenGui)
KeyboardFrame.Name = "KeyboardFrame"
KeyboardFrame.Size = UDim2.new(0, 400, 0, 160)
KeyboardFrame.Position = UDim2.new(0.1, 0, 0.5, -80)
KeyboardFrame.BackgroundColor3 = THEME.Background
KeyboardFrame.Visible = showKeyboard
EnableDragging(KeyboardFrame)
Instance.new("UICorner", KeyboardFrame).CornerRadius = UDim.new(0, 8)
local KStroke = Instance.new("UIStroke", KeyboardFrame)
KStroke.Color = THEME.Accent
KStroke.Transparency = 0.6
KStroke.Thickness = 2

local Keys = {}
local function CreateKey(char, pos, size)
    local k = Instance.new("Frame", KeyboardFrame)
    k.Size = size or UDim2.new(0, 30, 0, 30)
    k.Position = pos
    k.BackgroundColor3 = THEME.ItemBG
    Instance.new("UICorner", k).CornerRadius = UDim.new(0, 4)
    local l = Instance.new("TextLabel", k)
    l.Size = UDim2.new(1,0,1,0)
    l.BackgroundTransparency = 1
    l.Text = char:upper()
    l.TextColor3 = THEME.Text
    l.Font = Enum.Font.GothamBold
    l.TextSize = 14
    Keys[char:lower()] = k
    return k
end

local function GenerateKeyboard()
    for _, c in ipairs(KeyboardFrame:GetChildren()) do
        if c:IsA("Frame") or c:IsA("TextLabel") then c:Destroy() end
    end
    Keys = {}
    local rows
    if keyboardLayout == "QWERTZ" then
        rows = {{"q","w","e","r","t","z","u","i","o","p"},{"a","s","d","f","g","h","j","k","l"},{"y","x","c","v","b","n","m"}}
    elseif keyboardLayout == "AZERTY" then
        rows = {{"a","z","e","r","t","y","u","i","o","p"},{"q","s","d","f","g","h","j","k","l","m"},{"w","x","c","v","b","n"}}
    else
        rows = {{"q","w","e","r","t","y","u","i","o","p"},{"a","s","d","f","g","h","j","k","l"},{"z","x","c","v","b","n","m"}}
    end
    local startY = 15
    for r, rowChars in ipairs(rows) do
        local rowWidth = #rowChars * 35
        local startX = (400 - rowWidth) / 2
        for i, char in ipairs(rowChars) do
            CreateKey(char, UDim2.new(0, startX + (i-1)*35, 0, startY + (r-1)*35))
        end
    end
    CreateKey(" ", UDim2.new(0.5, -100, 0, startY + 3*35), UDim2.new(0, 200, 0, 30))
end
GenerateKeyboard()

UserInputService.InputBegan:Connect(function(input)
    if not showKeyboard then return end
    if input.UserInputType == Enum.UserInputType.Keyboard then
        local char = input.KeyCode.Name:lower()
        if Keys[char] then Tween(Keys[char], {BackgroundColor3 = THEME.Accent}, 0.1) end
        if input.KeyCode == Enum.KeyCode.Space and Keys[" "] then
            Tween(Keys[" "], {BackgroundColor3 = THEME.Accent}, 0.1)
        end
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if not showKeyboard then return end
    if input.UserInputType == Enum.UserInputType.Keyboard then
        local char = input.KeyCode.Name:lower()
        if Keys[char] then Tween(Keys[char], {BackgroundColor3 = THEME.ItemBG}, 0.2) end
        if input.KeyCode == Enum.KeyCode.Space and Keys[" "] then
            Tween(Keys[" "], {BackgroundColor3 = THEME.ItemBG}, 0.2)
        end
    end
end)

local SliderLabel = Instance.new("TextLabel", SlidersFrame)
SliderLabel.Text = "Speed: " .. currentCPM .. " CPM"
SliderLabel.Font = Enum.Font.GothamMedium
SliderLabel.TextSize = 12
SliderLabel.TextColor3 = THEME.SubText
SliderLabel.Size = UDim2.new(1, -30, 0, 20)
SliderLabel.Position = UDim2.new(0, 15, 0, 8)
SliderLabel.BackgroundTransparency = 1
SliderLabel.TextXAlignment = Enum.TextXAlignment.Left

local SliderBg = Instance.new("Frame", SlidersFrame)
SliderBg.Size = UDim2.new(1, -30, 0, 6)
SliderBg.Position = UDim2.new(0, 15, 0, 30)
SliderBg.BackgroundColor3 = THEME.Slider
Instance.new("UICorner", SliderBg).CornerRadius = UDim.new(1, 0)

local SliderFill = Instance.new("Frame", SliderBg)
SliderFill.Size = UDim2.new(0.5, 0, 1, 0)
SliderFill.BackgroundColor3 = THEME.Accent
Instance.new("UICorner", SliderFill).CornerRadius = UDim.new(1, 0)

local SliderBtn = Instance.new("TextButton", SliderBg)
SliderBtn.Size = UDim2.new(1,0,1,0)
SliderBtn.BackgroundTransparency = 1
SliderBtn.Text = ""

local ErrorLabel = Instance.new("TextLabel", SlidersFrame)
ErrorLabel.Text = "Error Rate: " .. errorRate .. "%"
ErrorLabel.Font = Enum.Font.GothamMedium
ErrorLabel.TextSize = 11
ErrorLabel.TextColor3 = THEME.SubText
ErrorLabel.Size = UDim2.new(1, -30, 0, 18)
ErrorLabel.Position = UDim2.new(0, 15, 0, 36)
ErrorLabel.BackgroundTransparency = 1
ErrorLabel.TextXAlignment = Enum.TextXAlignment.Left

local ErrorBg = Instance.new("Frame", SlidersFrame)
ErrorBg.Size = UDim2.new(1, -30, 0, 6)
ErrorBg.Position = UDim2.new(0, 15, 0, 56)
ErrorBg.BackgroundColor3 = THEME.Slider
Instance.new("UICorner", ErrorBg).CornerRadius = UDim.new(1, 0)

local ErrorFill = Instance.new("Frame", ErrorBg)
ErrorFill.Size = UDim2.new(errorRate/30, 0, 1, 0)
ErrorFill.BackgroundColor3 = Color3.fromRGB(200, 100, 100)
Instance.new("UICorner", ErrorFill).CornerRadius = UDim.new(1, 0)

local ErrorBtn = Instance.new("TextButton", ErrorBg)
ErrorBtn.Size = UDim2.new(1,0,1,0)
ErrorBtn.BackgroundTransparency = 1
ErrorBtn.Text = ""

SetupSlider(ErrorBtn, ErrorBg, ErrorFill, function(pct)
    errorRate = math.floor(pct * 30)
    Config.ErrorRate = errorRate
    ErrorFill.Size = UDim2.new(pct, 0, 1, 0)
    ErrorLabel.Text = "Error Rate: " .. errorRate .. "%"
end)

local ThinkLabel = Instance.new("TextLabel", SlidersFrame)
ThinkLabel.Text = string.format("Think: %.2fs", thinkDelayCurrent)
ThinkLabel.Font = Enum.Font.GothamMedium
ThinkLabel.TextSize = 11
ThinkLabel.TextColor3 = THEME.SubText
ThinkLabel.Size = UDim2.new(1, -30, 0, 18)
ThinkLabel.Position = UDim2.new(0, 15, 0, 62)
ThinkLabel.BackgroundTransparency = 1
ThinkLabel.TextXAlignment = Enum.TextXAlignment.Left

local ThinkBg = Instance.new("Frame", SlidersFrame)
ThinkBg.Size = UDim2.new(1, -30, 0, 6)
ThinkBg.Position = UDim2.new(0, 15, 0, 82)
ThinkBg.BackgroundColor3 = THEME.Slider
Instance.new("UICorner", ThinkBg).CornerRadius = UDim.new(1, 0)

local ThinkFill = Instance.new("Frame", ThinkBg)
local thinkPct = (thinkDelayCurrent - thinkDelayMin) / (thinkDelayMax - thinkDelayMin)
ThinkFill.Size = UDim2.new(thinkPct, 0, 1, 0)
ThinkFill.BackgroundColor3 = THEME.Accent
Instance.new("UICorner", ThinkFill).CornerRadius = UDim.new(1, 0)

local ThinkBtn = Instance.new("TextButton", ThinkBg)
ThinkBtn.Size = UDim2.new(1,0,1,0)
ThinkBtn.BackgroundTransparency = 1
ThinkBtn.Text = ""

SetupSlider(ThinkBtn, ThinkBg, ThinkFill, function(pct)
    thinkDelayCurrent = thinkDelayMin + pct * (thinkDelayMax - thinkDelayMin)
    Config.ThinkDelay = thinkDelayCurrent
    ThinkFill.Size = UDim2.new(pct, 0, 1, 0)
    ThinkLabel.Text = string.format("Think: %.2fs", thinkDelayCurrent)
end)

local function CreateToggle(text, pos, size, callback)
    local btn = Instance.new("TextButton", TogglesFrame)
    btn.Text = text
    btn.Font = Enum.Font.GothamMedium
    btn.TextSize = 11
    btn.TextColor3 = THEME.Success
    btn.BackgroundColor3 = THEME.Background
    btn.Size = size or UDim2.new(0, 85, 0, 24)
    btn.Position = pos
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 4)
    btn.MouseButton1Click:Connect(function()
        local newState, newText, newColor = callback()
        btn.Text = newText
        btn.TextColor3 = newColor
        SaveConfig()
    end)
    return btn
end

local HumanizeBtn = CreateToggle("Humanize: "..(useHumanization and "ON" or "OFF"), UDim2.new(0, 15, 0, 5), nil, function()
    useHumanization = not useHumanization
    Config.Humanize = useHumanization
    return useHumanization, "Humanize: "..(useHumanization and "ON" or "OFF"), useHumanization and THEME.Success or Color3.fromRGB(255, 100, 100)
end)
HumanizeBtn.TextColor3 = useHumanization and THEME.Success or Color3.fromRGB(255, 100, 100)

local FingerBtn = CreateToggle("10-Finger: "..(useFingerModel and "ON" or "OFF"), UDim2.new(0, 105, 0, 5), nil, function()
    useFingerModel = not useFingerModel
    Config.FingerModel = useFingerModel
    return useFingerModel, "10-Finger: "..(useFingerModel and "ON" or "OFF"), useFingerModel and THEME.Success or Color3.fromRGB(255, 100, 100)
end)
FingerBtn.TextColor3 = useFingerModel and THEME.Success or Color3.fromRGB(255, 100, 100)

local KeyboardBtn = CreateToggle("Keyboard: "..(showKeyboard and "ON" or "OFF"), UDim2.new(0, 195, 0, 5), nil, function()
    showKeyboard = not showKeyboard
    Config.ShowKeyboard = showKeyboard
    KeyboardFrame.Visible = showKeyboard
    return showKeyboard, "Keyboard: "..(showKeyboard and "ON" or "OFF"), showKeyboard and THEME.Success or Color3.fromRGB(255, 100, 100)
end)
KeyboardBtn.TextColor3 = showKeyboard and THEME.Success or Color3.fromRGB(255, 100, 100)

local SortBtn = CreateToggle("Sort: "..sortMode, UDim2.new(0, 15, 0, 33), UDim2.new(0, 130, 0, 24), function()
    if sortMode == "Random" then sortMode = "Shortest"
    elseif sortMode == "Shortest" then sortMode = "Longest"
    elseif sortMode == "Longest" then sortMode = "Killer"
    else sortMode = "Random" end
    Config.SortMode = sortMode
    lastDetected = "---"
    return true, "Sort: "..sortMode, THEME.Accent
end)
SortBtn.TextColor3 = THEME.Accent

local AutoBtn = CreateToggle("Auto Play: "..(autoPlay and "ON" or "OFF"), UDim2.new(0, 150, 0, 33), UDim2.new(0, 130, 0, 24), function()
    autoPlay = not autoPlay
    Config.AutoPlay = autoPlay
    return autoPlay, "Auto Play: "..(autoPlay and "ON" or "OFF"), autoPlay and THEME.Success or Color3.fromRGB(255, 100, 100)
end)
AutoBtn.TextColor3 = autoPlay and THEME.Success or Color3.fromRGB(255, 100, 100)

local BlatantBtn = CreateToggle("Blatant Mode: "..(isBlatant and "ON" or "OFF"), UDim2.new(0, 15, 0, 61), UDim2.new(0, 130, 0, 24), function()
    isBlatant = not isBlatant
    Config.Blatant = isBlatant
    return isBlatant, "Blatant Mode: "..(isBlatant and "ON" or "OFF"), isBlatant and Color3.fromRGB(255, 80, 80) or THEME.SubText
end)
BlatantBtn.TextColor3 = isBlatant and Color3.fromRGB(255, 80, 80) or THEME.SubText

local RiskyBtn = CreateToggle("Risky Mistakes: "..(riskyMistakes and "ON" or "OFF"), UDim2.new(0, 150, 0, 61), UDim2.new(0, 130, 0, 24), function()
    riskyMistakes = not riskyMistakes
    Config.RiskyMistakes = riskyMistakes
    return riskyMistakes, "Risky Mistakes: "..(riskyMistakes and "ON" or "OFF"), riskyMistakes and Color3.fromRGB(255, 80, 80) or THEME.SubText
end)
RiskyBtn.TextColor3 = riskyMistakes and Color3.fromRGB(255, 80, 80) or THEME.SubText

local PanicBtn = CreateToggle("Panic Mode: "..(panicMode and "ON" or "OFF"), UDim2.new(0, 15, 0, 89), UDim2.new(0, 130, 0, 24), function()
    panicMode = not panicMode
    Config.PanicMode = panicMode
    return panicMode, "Panic Mode: "..(panicMode and "ON" or "OFF"), panicMode and THEME.Warning or THEME.SubText
end)
PanicBtn.TextColor3 = panicMode and THEME.Warning or THEME.SubText

-- Min Word Length toggle
local MinLenBtn = CreateToggle("Min Huruf: "..minWordLength, UDim2.new(0, 150, 0, 89), UDim2.new(0, 130, 0, 24), function()
    minWordLength = minWordLength >= 6 and 3 or minWordLength + 1
    Config.MinWordLength = minWordLength
    return true, "Min Huruf: "..minWordLength, THEME.Accent
end)
MinLenBtn.TextColor3 = THEME.Accent

local ManageWordsBtn = Instance.new("TextButton", TogglesFrame)
ManageWordsBtn.Text = "Manage Custom Words"
ManageWordsBtn.Font = Enum.Font.GothamMedium
ManageWordsBtn.TextSize = 11
ManageWordsBtn.TextColor3 = THEME.Accent
ManageWordsBtn.BackgroundColor3 = THEME.Background
ManageWordsBtn.Size = UDim2.new(0, 265, 0, 24)
ManageWordsBtn.Position = UDim2.new(0, 15, 0, 117)
Instance.new("UICorner", ManageWordsBtn).CornerRadius = UDim.new(0, 4)

local WordBrowserBtn = Instance.new("TextButton", TogglesFrame)
WordBrowserBtn.Text = "Word Browser"
WordBrowserBtn.Font = Enum.Font.GothamMedium
WordBrowserBtn.TextSize = 11
WordBrowserBtn.TextColor3 = Color3.fromRGB(200, 150, 255)
WordBrowserBtn.BackgroundColor3 = THEME.Background
WordBrowserBtn.Size = UDim2.new(0, 265, 0, 24)
WordBrowserBtn.Position = UDim2.new(0, 15, 0, 145)
Instance.new("UICorner", WordBrowserBtn).CornerRadius = UDim.new(0, 4)

-- Custom Words Frame
local CustomWordsFrame = Instance.new("Frame", ScreenGui)
CustomWordsFrame.Name = "CustomWordsFrame"
CustomWordsFrame.Size = UDim2.new(0, 250, 0, 350)
CustomWordsFrame.Position = UDim2.new(0.5, -125, 0.5, -175)
CustomWordsFrame.BackgroundColor3 = THEME.Background
CustomWordsFrame.Visible = false
CustomWordsFrame.ClipsDescendants = true
EnableDragging(CustomWordsFrame)
Instance.new("UICorner", CustomWordsFrame).CornerRadius = UDim.new(0, 8)
local CWStroke = Instance.new("UIStroke", CustomWordsFrame)
CWStroke.Color = THEME.Accent
CWStroke.Transparency = 0.5
CWStroke.Thickness = 2

local CWHeader = Instance.new("TextLabel", CustomWordsFrame)
CWHeader.Text = "Custom Words Manager"
CWHeader.Font = Enum.Font.GothamBold
CWHeader.TextSize = 14
CWHeader.TextColor3 = THEME.Text
CWHeader.Size = UDim2.new(1, 0, 0, 35)
CWHeader.BackgroundTransparency = 1

local CWCloseBtn = Instance.new("TextButton", CustomWordsFrame)
CWCloseBtn.Text = "X"
CWCloseBtn.Font = Enum.Font.GothamBold
CWCloseBtn.TextSize = 14
CWCloseBtn.TextColor3 = Color3.fromRGB(255, 100, 100)
CWCloseBtn.Size = UDim2.new(0, 30, 0, 30)
CWCloseBtn.Position = UDim2.new(1, -30, 0, 2)
CWCloseBtn.BackgroundTransparency = 1
CWCloseBtn.MouseButton1Click:Connect(function() CustomWordsFrame.Visible = false end)

ManageWordsBtn.MouseButton1Click:Connect(function()
    CustomWordsFrame.Visible = not CustomWordsFrame.Visible
    CustomWordsFrame.Parent = nil
    CustomWordsFrame.Parent = ScreenGui
end)

local function SetupPhantomBox(box, placeholder)
    box.Text = placeholder
    box.TextColor3 = THEME.SubText
    box.Focused:Connect(function()
        if box.Text == placeholder then box.Text = "" box.TextColor3 = THEME.Text end
    end)
    box.FocusLost:Connect(function()
        if box.Text == "" then box.Text = placeholder box.TextColor3 = THEME.SubText end
    end)
end

local CWSearchBox = Instance.new("TextBox", CustomWordsFrame)
CWSearchBox.Font = Enum.Font.Gotham
CWSearchBox.TextSize = 12
CWSearchBox.BackgroundColor3 = THEME.ItemBG
CWSearchBox.Size = UDim2.new(1, -20, 0, 24)
CWSearchBox.Position = UDim2.new(0, 10, 0, 35)
Instance.new("UICorner", CWSearchBox).CornerRadius = UDim.new(0, 4)
SetupPhantomBox(CWSearchBox, "Search words...")

local CWScroll = Instance.new("ScrollingFrame", CustomWordsFrame)
CWScroll.Size = UDim2.new(1, -10, 1, -110)
CWScroll.Position = UDim2.new(0, 5, 0, 65)
CWScroll.BackgroundTransparency = 1
CWScroll.ScrollBarThickness = 2
CWScroll.ScrollBarImageColor3 = THEME.Accent
CWScroll.CanvasSize = UDim2.new(0,0,0,0)

local CWListLayout = Instance.new("UIListLayout", CWScroll)
CWListLayout.SortOrder = Enum.SortOrder.LayoutOrder
CWListLayout.Padding = UDim.new(0, 2)

local CWAddBox = Instance.new("TextBox", CustomWordsFrame)
CWAddBox.Font = Enum.Font.Gotham
CWAddBox.TextSize = 12
CWAddBox.BackgroundColor3 = THEME.ItemBG
CWAddBox.Size = UDim2.new(0, 170, 0, 24)
CWAddBox.Position = UDim2.new(0, 10, 1, -35)
Instance.new("UICorner", CWAddBox).CornerRadius = UDim.new(0, 4)
SetupPhantomBox(CWAddBox, "Tambah kata baru...")

local CWAddBtn = Instance.new("TextButton", CustomWordsFrame)
CWAddBtn.Text = "Add"
CWAddBtn.Font = Enum.Font.GothamBold
CWAddBtn.TextSize = 11
CWAddBtn.TextColor3 = THEME.Success
CWAddBtn.BackgroundColor3 = THEME.ItemBG
CWAddBtn.Size = UDim2.new(0, 50, 0, 24)
CWAddBtn.Position = UDim2.new(1, -60, 1, -35)
Instance.new("UICorner", CWAddBtn).CornerRadius = UDim.new(0, 4)

local SmartType -- forward declare

local function RefreshCustomWords()
    for _, c in ipairs(CWScroll:GetChildren()) do
        if c:IsA("Frame") then c:Destroy() end
    end
    local queryRaw = CWSearchBox.Text
    local query = (queryRaw == "Search words...") and "" or queryRaw:lower():gsub("[%s%c]+", "")
    local list = Config.CustomWords or {}
    local shownCount = 0
    for i, w in ipairs(list) do
        if query == "" or w:find(query, 1, true) then
            shownCount = shownCount + 1
            local row = Instance.new("TextButton", CWScroll)
            row.Size = UDim2.new(1, -6, 0, 22)
            row.BackgroundColor3 = (shownCount % 2 == 0) and Color3.fromRGB(25,25,30) or Color3.fromRGB(30,30,35)
            row.BorderSizePixel = 0
            row.Text = ""
            row.AutoButtonColor = false
            Instance.new("UICorner", row).CornerRadius = UDim.new(0, 4)
            row.MouseButton1Click:Connect(function()
                if SmartType then SmartType(w, lastDetected, true, true) end
                Tween(row, {BackgroundColor3 = THEME.Accent}, 0.2)
                task.delay(0.2, function()
                    Tween(row, {BackgroundColor3 = (shownCount % 2 == 0) and Color3.fromRGB(25,25,30) or Color3.fromRGB(30,30,35)}, 0.2)
                end)
            end)
            local lbl = Instance.new("TextLabel", row)
            lbl.Text = w
            lbl.Font = Enum.Font.Gotham
            lbl.TextSize = 12
            lbl.TextColor3 = THEME.Text
            lbl.Size = UDim2.new(1, -30, 1, 0)
            lbl.Position = UDim2.new(0, 5, 0, 0)
            lbl.BackgroundTransparency = 1
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            local del = Instance.new("TextButton", row)
            del.Text = "X"
            del.Font = Enum.Font.GothamBold
            del.TextSize = 11
            del.TextColor3 = Color3.fromRGB(255, 80, 80)
            del.Size = UDim2.new(0, 22, 1, 0)
            del.Position = UDim2.new(1, -22, 0, 0)
            del.BackgroundTransparency = 1
            del.MouseButton1Click:Connect(function()
                table.remove(Config.CustomWords, i)
                SaveConfig()
                Blacklist[w] = true
                RefreshCustomWords()
                ShowToast("Dihapus: " .. w, "warning")
            end)
        end
    end
    CWScroll.CanvasSize = UDim2.new(0, 0, 0, shownCount * 24)
end

CWSearchBox:GetPropertyChangedSignal("Text"):Connect(RefreshCustomWords)

CWAddBtn.MouseButton1Click:Connect(function()
    local text = CWAddBox.Text
    if text == "Tambah kata baru..." then return end
    text = text:gsub("[%s%c]+", ""):lower()
    if #text < minWordLength then return end
    if not Config.CustomWords then Config.CustomWords = {} end
    for _, w in ipairs(Config.CustomWords) do
        if w == text then ShowToast("Kata sudah ada!", "warning") return end
    end
    local c = text:sub(1,1)
    local existsInMain = false
    if Buckets and Buckets[c] then
        for _, w in ipairs(Buckets[c]) do
            if w == text then existsInMain = true break end
        end
    end
    if existsInMain then ShowToast("Sudah ada di kamus!", "error") return end
    table.insert(Config.CustomWords, text)
    SaveConfig()
    table.insert(Words, text)
    if c == "" then c = "#" end
    Buckets[c] = Buckets[c] or {}
    table.insert(Buckets[c], text)
    CWAddBox.Text = ""
    CWAddBox:ReleaseFocus()
    RefreshCustomWords()
    ShowToast("Ditambah: " .. text, "success")
end)

RefreshCustomWords()

-- Word Browser
do
    local WordBrowserFrame = Instance.new("Frame", ScreenGui)
    WordBrowserFrame.Name = "WordBrowser"
    WordBrowserFrame.Size = UDim2.new(0, 300, 0, 400)
    WordBrowserFrame.Position = UDim2.new(0.5, -150, 0.5, -200)
    WordBrowserFrame.BackgroundColor3 = THEME.Background
    WordBrowserFrame.Visible = false
    WordBrowserFrame.ClipsDescendants = true
    EnableDragging(WordBrowserFrame)
    Instance.new("UICorner", WordBrowserFrame).CornerRadius = UDim.new(0, 8)
    local WBStroke = Instance.new("UIStroke", WordBrowserFrame)
    WBStroke.Color = THEME.Accent
    WBStroke.Transparency = 0.5
    WBStroke.Thickness = 2

    local WBHeader = Instance.new("TextLabel", WordBrowserFrame)
    WBHeader.Text = "Word Browser"
    WBHeader.Font = Enum.Font.GothamBold
    WBHeader.TextSize = 16
    WBHeader.TextColor3 = THEME.Text
    WBHeader.Size = UDim2.new(1, 0, 0, 40)
    WBHeader.BackgroundTransparency = 1

    local WBClose = Instance.new("TextButton", WordBrowserFrame)
    WBClose.Text = "X"
    WBClose.Font = Enum.Font.GothamBold
    WBClose.TextSize = 16
    WBClose.TextColor3 = Color3.fromRGB(255, 100, 100)
    WBClose.Size = UDim2.new(0, 40, 0, 40)
    WBClose.Position = UDim2.new(1, -40, 0, 0)
    WBClose.BackgroundTransparency = 1
    WBClose.MouseButton1Click:Connect(function() WordBrowserFrame.Visible = false end)

    local WBStartBox = Instance.new("TextBox", WordBrowserFrame)
    WBStartBox.Font = Enum.Font.Gotham
    WBStartBox.TextSize = 12
    WBStartBox.BackgroundColor3 = THEME.ItemBG
    WBStartBox.Size = UDim2.new(0.4, 0, 0, 24)
    WBStartBox.Position = UDim2.new(0, 10, 0, 45)
    Instance.new("UICorner", WBStartBox).CornerRadius = UDim.new(0, 4)
    SetupPhantomBox(WBStartBox, "Diawali...")

    local WBEndBox = Instance.new("TextBox", WordBrowserFrame)
    WBEndBox.Font = Enum.Font.Gotham
    WBEndBox.TextSize = 12
    WBEndBox.BackgroundColor3 = THEME.ItemBG
    WBEndBox.Size = UDim2.new(0.4, 0, 0, 24)
    WBEndBox.Position = UDim2.new(0.45, 0, 0, 45)
    Instance.new("UICorner", WBEndBox).CornerRadius = UDim.new(0, 4)
    SetupPhantomBox(WBEndBox, "Diakhiri...")

    local WBLengthBox = Instance.new("TextBox", WordBrowserFrame)
    WBLengthBox.Font = Enum.Font.Gotham
    WBLengthBox.TextSize = 12
    WBLengthBox.BackgroundColor3 = THEME.ItemBG
    WBLengthBox.Size = UDim2.new(0.2, 0, 0, 24)
    WBLengthBox.Position = UDim2.new(0.02, 0, 0, 80)
    Instance.new("UICorner", WBLengthBox).CornerRadius = UDim.new(0, 4)
    SetupPhantomBox(WBLengthBox, "Len...")

    local WBSearchBtn = Instance.new("TextButton", WordBrowserFrame)
    WBSearchBtn.Text = "Go"
    WBSearchBtn.Font = Enum.Font.GothamBold
    WBSearchBtn.TextSize = 12
    WBSearchBtn.BackgroundColor3 = THEME.Accent
    WBSearchBtn.Size = UDim2.new(0.1, 0, 0, 24)
    WBSearchBtn.Position = UDim2.new(0.88, 0, 0, 45)
    Instance.new("UICorner", WBSearchBtn).CornerRadius = UDim.new(0, 4)

    local WBList = Instance.new("ScrollingFrame", WordBrowserFrame)
    WBList.Size = UDim2.new(1, -20, 1, -125)
    WBList.Position = UDim2.new(0, 10, 0, 115)
    WBList.BackgroundTransparency = 1
    WBList.ScrollBarThickness = 3
    WBList.ScrollBarImageColor3 = THEME.Accent
    WBList.CanvasSize = UDim2.new(0,0,0,0)

    local WBLayout = Instance.new("UIListLayout", WBList)
    WBLayout.Padding = UDim.new(0, 2)
    WBLayout.SortOrder = Enum.SortOrder.LayoutOrder

    local function SearchWords()
        for _, c in ipairs(WBList:GetChildren()) do
            if c:IsA("GuiObject") and c.Name ~= "UIListLayout" then c:Destroy() end
        end
        local sVal = WBStartBox.Text
        local eVal = WBEndBox.Text
        local lVal = tonumber(WBLengthBox.Text)
        if sVal == "Diawali..." then sVal = "" end
        if eVal == "Diakhiri..." then eVal = "" end
        sVal = sVal:lower():gsub("[%s%c]+", "")
        eVal = eVal:lower():gsub("[%s%c]+", "")
        suffixMode = eVal
        Config.SuffixMode = eVal
        lengthMode = lVal or 0
        Config.LengthMode = lengthMode
        if UpdateList then UpdateList(lastDetected, lastRequiredLetter) end
        if sVal == "" and eVal == "" and not lVal then return end
        local results = {}
        local limit = 200
        local bucket = Words
        if sVal ~= "" then
            local c = sVal:sub(1,1)
            if Buckets and Buckets[c] then bucket = Buckets[c] end
        end
        for _, w in ipairs(bucket) do
            local matchStart = (sVal == "") or (w:sub(1, #sVal) == sVal)
            local matchEnd = (eVal == "") or (w:sub(-#eVal) == eVal)
            local matchLen = (not lVal) or (#w == lVal)
            if matchStart and matchEnd and matchLen then
                table.insert(results, w)
                if #results >= limit then break end
            end
        end
        for i, w in ipairs(results) do
            local row = Instance.new("TextButton", WBList)
            row.Size = UDim2.new(1, -6, 0, 22)
            row.BackgroundColor3 = (i % 2 == 0) and Color3.fromRGB(25,25,30) or Color3.fromRGB(30,30,35)
            row.Text = ""
            row.AutoButtonColor = false
            Instance.new("UICorner", row).CornerRadius = UDim.new(0, 4)
            row.MouseButton1Click:Connect(function()
                if SmartType then SmartType(w, lastDetected, true, true) end
                Tween(row, {BackgroundColor3 = THEME.Accent}, 0.2)
                task.delay(0.2, function()
                    Tween(row, {BackgroundColor3 = (i % 2 == 0) and Color3.fromRGB(25,25,30) or Color3.fromRGB(30,30,35)}, 0.2)
                end)
            end)
            local lbl = Instance.new("TextLabel", row)
            lbl.Text = w
            lbl.Font = Enum.Font.Gotham
            lbl.TextSize = 12
            lbl.TextColor3 = THEME.Text
            lbl.Size = UDim2.new(1, -10, 1, 0)
            lbl.Position = UDim2.new(0, 5, 0, 0)
            lbl.BackgroundTransparency = 1
            lbl.TextXAlignment = Enum.TextXAlignment.Left
        end
        WBList.CanvasSize = UDim2.new(0,0,0, WBLayout.AbsoluteContentSize.Y)
    end

    WBSearchBtn.MouseButton1Click:Connect(SearchWords)
    WBStartBox.FocusLost:Connect(function(enter) if enter then SearchWords() end end)
    WBEndBox.FocusLost:Connect(function(enter) if enter then SearchWords() end end)
    WBLengthBox.FocusLost:Connect(function(enter) if enter then SearchWords() end end)

    WordBrowserBtn.MouseButton1Click:Connect(function()
        WordBrowserFrame.Visible = not WordBrowserFrame.Visible
        WordBrowserFrame.Parent = nil
        WordBrowserFrame.Parent = ScreenGui
    end)
end

-- ============================================================
-- TYPING ENGINE
-- ============================================================
local KEY_POS = {}
do
    local row1 = "qwertyuiop"
    local row2 = "asdfghjkl"
    local row3 = "zxcvbnm"
    for i = 1, #row1 do KEY_POS[row1:sub(i,i)] = {x = i, y = 1} end
    for i = 1, #row2 do KEY_POS[row2:sub(i,i)] = {x = i + 0.5, y = 2} end
    for i = 1, #row3 do KEY_POS[row3:sub(i,i)] = {x = i + 1, y = 3} end
end

local function KeyDistance(a, b)
    if not a or not b then return 1 end
    a = a:lower() b = b:lower()
    local pa = KEY_POS[a]
    local pb = KEY_POS[b]
    if not pa or not pb then return 1 end
    local dx = pa.x - pb.x
    local dy = pa.y - pb.y
    return math.sqrt(dx*dx + dy*dy)
end

local lastKey = nil
local function CalculateDelayForKeys(prevChar, nextChar)
    if isBlatant then return 60 / currentCPM end
    local baseDelay = 60 / currentCPM
    local variance = baseDelay * 0.35
    local extra = 0
    if useHumanization and useFingerModel and prevChar and nextChar and prevChar ~= "" then
        local dist = KeyDistance(prevChar, nextChar)
        extra = dist * 0.018 * (550 / math.max(150, currentCPM))
        local pa = KEY_POS[prevChar:lower()]
        local pb = KEY_POS[nextChar:lower()]
        if pa and pb then
            if (pa.x <= 5 and pb.x <= 5) or (pa.x > 5 and pb.x > 5) then
                extra = extra * 0.8
            end
        end
    end
    if useHumanization then
        local r = (math.random() + math.random() + math.random()) / 3
        local noise = (r * 2 - 1) * variance
        return math.max(0.01, baseDelay + extra + noise)
    else
        return baseDelay
    end
end

local function SimulateKey(input)
    if typeof(input) == "string" and #input == 1 then
        local char = input
        local vimSuccess = pcall(function() VirtualInputManager:SendTextInput(char) end)
        if not vimSuccess then
            local key
            pcall(function() key = Enum.KeyCode[input:upper()] end)
            if key then
                pcall(function()
                    VirtualInputManager:SendKeyEvent(true, key, false, game)
                    task.wait(0.015)
                    VirtualInputManager:SendKeyEvent(false, key, false, game)
                end)
            end
        end
        return
    end
    local key
    if typeof(input) == "EnumItem" then
        key = input
    else
        pcall(function() key = Enum.KeyCode[input:upper()] end)
    end
    if key then
        pcall(function()
            VirtualInputManager:SendKeyEvent(true, key, false, game)
            task.wait(0.015)
            VirtualInputManager:SendKeyEvent(false, key, false, game)
        end)
    end
end

local function Backspace(count)
    local key = Enum.KeyCode.Backspace
    for i = 1, count do
        pcall(function()
            VirtualInputManager:SendKeyEvent(true, key, false, game)
            task.wait(0.012)
            VirtualInputManager:SendKeyEvent(false, key, false, game)
        end)
        if i % 15 == 0 then task.wait(0.02) end
    end
    lastKey = nil
end

local function PressEnter()
    pcall(function()
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
        task.wait(0.015)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
    end)
    lastKey = nil
end

local function ClearTypedWord()
    local typed = GetCurrentGameWord()
    if #typed > 0 then
        Backspace(#typed + 3)
        task.wait(0.1)
    end
end

-- ============================================================
-- [GANTI] SmartType — lanjut dari yang sudah diketik
-- ============================================================
SmartType = function(targetWord, currentDetected, isCorrection, bypassTurn)
    if unloaded then return end

    if #targetWord < minWordLength then return end

    -- [FIX] Cek apakah user sedang di chat/textbox lain
    if not bypassTurn then
        local focused = UserInputService:GetFocusedTextBox()
        local matchUI = GetMatchUI()
        if focused and matchUI and not focused:IsDescendantOf(matchUI) then return end
    end

    if isTyping then
        if (tick() - lastTypingStart) > 15 then
            isTyping = false
            isAutoPlayScheduled = false
        else
            return
        end
    end

    -- Cek giliran
    local myTurn, _ = GetTurnInfo()
    if not bypassTurn and not myTurn then return end

    isTyping = true
    lastTypingStart = tick()
    lastKey = nil

    local targetBox = GetGameTextBox()
    if targetBox then
        targetBox:CaptureFocus()
        task.wait(0.1)
    end

    StatusText.Text = "Mengetik: " .. targetWord
    StatusText.TextColor3 = THEME.Accent
    Tween(StatusDot, {BackgroundColor3 = THEME.Accent})

    local success, err = pcall(function()
        -- [FIX] Baca kata yang sudah ada di kotak (sort by X)
        local alreadyTyped = GetCurrentGameWord()
        local toType = ""

        if #alreadyTyped > 0 and targetWord:sub(1, #alreadyTyped):lower() == alreadyTyped:lower() then
            -- Kata target diawali dengan yang sudah diketik → lanjut saja
            toType = targetWord:sub(#alreadyTyped + 1)
        else
            -- Berbeda → hapus dulu baru ketik ulang
            if #alreadyTyped > 0 then
                Backspace(#alreadyTyped + 3)
                task.wait(0.15)
            end
            toType = targetWord
        end

        local letters = "abcdefghijklmnopqrstuvwxyz"
        for i = 1, #toType do
            -- Cek giliran tiap huruf
            if not bypassTurn then
                local stillMyTurn, _ = GetTurnInfo()
                if not stillMyTurn then
                    ClearTypedWord()
                    StatusText.Text = "Giliran habis, dibatalkan"
                    StatusText.TextColor3 = THEME.Warning
                    isTyping = false
                    isAutoPlayScheduled = false
                    return
                end
            end

            -- Cek chat aktif
            local foc = UserInputService:GetFocusedTextBox()
            local matchUI = GetMatchUI()
            if foc and matchUI and not foc:IsDescendantOf(matchUI) then
                ClearTypedWord()
                StatusText.Text = "Dibatalkan (chat aktif)"
                StatusText.TextColor3 = THEME.Warning
                isTyping = false
                isAutoPlayScheduled = false
                return
            end

            local ch = toType:sub(i, i)

            -- Error rate simulation
            if errorRate > 0 and math.random() < (errorRate / 100) then
                local typoChar
                repeat
                    local idx = math.random(1, #letters)
                    typoChar = letters:sub(idx, idx)
                until typoChar ~= ch
                SimulateKey(typoChar)
                task.wait(CalculateDelayForKeys(lastKey, typoChar))
                lastKey = typoChar
                local realize = thinkDelayCurrent * (0.5 + math.random() * 0.6)
                task.wait(realize)
                Backspace(1)
                task.wait(0.04 + math.random() * 0.06)
                SimulateKey(ch)
                task.wait(math.max(CalculateDelayForKeys(lastKey, ch), 0.03))
                lastKey = ch
            else
                SimulateKey(ch)
                task.wait(math.max(CalculateDelayForKeys(lastKey, ch), 0.03))
                lastKey = ch
            end

            if useHumanization and math.random() < 0.03 then
                task.wait(0.1 + math.random() * 0.3)
            end
        end

        task.wait(0.1)

        -- Kirim hanya kalau masih giliran kita
        local stillMyTurn, _ = GetTurnInfo()
        if bypassTurn or stillMyTurn then
            PressEnter()
            UsedWords[targetWord] = true
            StatusText.Text = "✓ Terkirim: " .. targetWord
            StatusText.TextColor3 = THEME.Success
            Tween(StatusDot, {BackgroundColor3 = THEME.Success})
        else
            ClearTypedWord()
            StatusText.Text = "Giliran habis sebelum enter"
            StatusText.TextColor3 = THEME.Warning
        end
    end)

    if not success then
        pcall(ClearTypedWord)
        StatusText.Text = "Error saat mengetik"
        StatusText.TextColor3 = Color3.fromRGB(255, 80, 80)
    end

    isTyping = false
    isAutoPlayScheduled = false
    forceUpdateList = true
    lastKey = nil
end

-- ============================================================
-- UPDATE LIST
-- ============================================================
local function GetMatchLength(str, prefix)
    local len = 0
    local max = math.min(#str, #prefix)
    for i = 1, max do
        local pb = string.byte(prefix, i)
        if pb == 35 or pb == string.byte(str, i) then
            len = i
        else
            break
        end
    end
    return len
end

local function BinarySearchStart(list, prefix)
    local left = 1
    local right = #list
    local result = -1
    local pLen = #prefix
    while left <= right do
        local mid = math.floor((left + right) / 2)
        local word = list[mid]
        local sub = word:sub(1, pLen)
        if sub == prefix then
            result = mid
            right = mid - 1
        elseif sub < prefix then
            left = mid + 1
        else
            right = mid - 1
        end
    end
    return result
end

UpdateList = function(detectedText, requiredLetter)
    local matches = {}
    local searchPrefix = detectedText or ""
    local isBacktracked = false
    local manualSearch = false

    if SearchBox and SearchBox.Text ~= "" then
        searchPrefix = SearchBox.Text:lower():gsub("[%s%c]+", "")
        manualSearch = true
    end

    if not manualSearch and requiredLetter and #requiredLetter > 0 then
        local reqLen = GetMatchLength(requiredLetter, searchPrefix)
        if reqLen == #searchPrefix and #requiredLetter > #searchPrefix then
            searchPrefix = requiredLetter
        end
    end

    local firstChar = searchPrefix:sub(1,1)
    if firstChar == "#" then firstChar = nil end
    if (not firstChar or firstChar == "") and requiredLetter then
        firstChar = requiredLetter:sub(1,1):lower()
    end

    local bucket
    if firstChar and firstChar ~= "" and Buckets then
        bucket = Buckets[firstChar] or {}
    else
        bucket = Words
    end

    local function CollectMatches(prefix)
        local exacts = {}
        local partials = {}
        local maxPartialLen = 0

        if bucket and #prefix > 0 then
            local startIndex = BinarySearchStart(bucket, prefix)
            if startIndex ~= -1 then
                for i = startIndex, #bucket do
                    local w = bucket[i]
                    if w:sub(1, #prefix) ~= prefix then break end
                    if Blacklist[w] or UsedWords[w] then goto continue end
                    if #w < minWordLength then goto continue end
                    if suffixMode ~= "" and w:sub(-#suffixMode) ~= suffixMode then goto continue end
                    if lengthMode > 0 and #w ~= lengthMode then goto continue end
                    table.insert(exacts, w)
                    if #exacts >= 120 then break end
                    ::continue::
                end
            end
        end

        return exacts, partials, maxPartialLen
    end

    local exacts, partials, pLen = CollectMatches(searchPrefix)

    if #exacts > 0 then
        matches = exacts
    elseif requiredLetter and #requiredLetter > 0 then
        local fallback, _, _ = CollectMatches(requiredLetter)
        if #fallback > 0 then
            matches = fallback
            searchPrefix = requiredLetter
            isBacktracked = true
        end
    end

    if #matches > 0 then
        if sortMode == "Longest" then
            table.sort(matches, function(a, b) return #a > #b end)
        elseif sortMode == "Shortest" then
            table.sort(matches, function(a, b) return #a < #b end)
        elseif sortMode == "Killer" then
            table.sort(matches, function(a, b)
                local sA = GetKillerScore(a)
                local sB = GetKillerScore(b)
                if sA == sB then return #a < #b end
                return sA > sB
            end)
        elseif sortMode == "Random" then
            shuffleTable(matches)
        end
    end

    local displayList = {}
    for i = 1, math.min(40, #matches) do table.insert(displayList, matches[i]) end

    if showKeyboard and KeyboardFrame.Visible then
        local colors = {Color3.fromRGB(100,255,140), Color3.fromRGB(255,180,200), Color3.fromRGB(100,200,255)}
        local targetKeys = {}
        for i = 1, math.min(3, #displayList) do
            local w = displayList[i]
            local nextChar = w:sub(#searchPrefix + 1, #searchPrefix + 1)
            if nextChar and nextChar ~= "" then
                local char = nextChar:lower()
                if not targetKeys[char] then targetKeys[char] = i end
            end
        end
        for char, k in pairs(Keys) do
            local priority = targetKeys[char]
            if priority then
                Tween(k, {BackgroundColor3 = colors[priority]}, 0.3)
            else
                Tween(k, {BackgroundColor3 = THEME.ItemBG}, 0.2)
            end
        end
    end

    currentBestMatch = (#matches > 0 and not isBacktracked) and matches[1] or nil

    for i = 1, math.max(#displayList, #ButtonCache) do
        local w = displayList[i]
        local btn = ButtonCache[i]

        if w then
            local lbl
            if not btn then
                btn = Instance.new("TextButton")
                btn.Size = UDim2.new(1, -6, 0, 30)
                btn.BackgroundColor3 = THEME.ItemBG
                btn.Text = ""
                btn.AutoButtonColor = false
                Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
                lbl = Instance.new("TextLabel", btn)
                lbl.Name = "Label"
                lbl.Size = UDim2.new(1, -20, 1, 0)
                lbl.Position = UDim2.new(0, 10, 0, 0)
                lbl.BackgroundTransparency = 1
                lbl.Font = Enum.Font.GothamMedium
                lbl.TextSize = 14
                lbl.TextXAlignment = Enum.TextXAlignment.Left
                lbl.RichText = true
                btn.MouseEnter:Connect(function() Tween(btn, {BackgroundColor3 = Color3.fromRGB(45,45,55)}) end)
                btn.MouseLeave:Connect(function() Tween(btn, {BackgroundColor3 = THEME.ItemBG}) end)
                btn.MouseButton1Click:Connect(function()
                    local d = ButtonData[btn]
                    if d then
                        SmartType(d.word, d.detected, true, true)
                        Tween(btn, {BackgroundColor3 = Color3.fromRGB(30,60,40)})
                    end
                end)
                btn.Parent = ScrollList
                table.insert(ButtonCache, btn)
            else
                lbl = btn:FindFirstChild("Label")
                btn.Visible = true
                btn.Parent = ScrollList
                btn.BackgroundColor3 = THEME.ItemBG
                if lbl then lbl.TextColor3 = THEME.Text end
            end

            ButtonData[btn] = {word = w, detected = detectedText}

            local accentRGB = ColorToRGB(THEME.Accent)
            if i == 1 then accentRGB = "100,255,140"
            elseif i == 2 then accentRGB = "255,180,200"
            elseif i == 3 then accentRGB = "100,200,255" end

            local textRGB = ColorToRGB(THEME.Text)
            local pfx = w:sub(1, #searchPrefix)
            local sfx = w:sub(#searchPrefix + 1)
            if lbl then
                lbl.Text = "<font color=\"rgb("..accentRGB..")\">"..pfx.."</font>"
                    .."<font color=\"rgb("..textRGB..")\">"..sfx.."</font>"
            end
        else
            if btn then
                btn.Visible = false
                ButtonData[btn] = nil
            end
        end
    end

    ScrollList.CanvasSize = UDim2.new(0,0,0, UIListLayout.AbsoluteContentSize.Y)
end

SetupSlider(SliderBtn, SliderBg, SliderFill, function(pct)
    local max = isBlatant and MAX_CPM_BLATANT or MAX_CPM_LEGIT
    currentCPM = math.floor(MIN_CPM + (pct * (max - MIN_CPM)))
    SliderFill.Size = UDim2.new(pct, 0, 1, 0)
    SliderLabel.Text = "Speed: " .. currentCPM .. " CPM"
    if currentCPM > 900 then Tween(SliderFill, {BackgroundColor3 = Color3.fromRGB(255,80,80)})
    else Tween(SliderFill, {BackgroundColor3 = THEME.Accent}) end
end)

MinBtn.MouseButton1Click:Connect(function()
    local isMin = MainFrame.Size.Y.Offset < 100
    if not isMin then
        Tween(MainFrame, {Size = UDim2.new(0, 300, 0, 45)})
        ScrollList.Visible = false
        SettingsFrame.Visible = false
        StatusFrame.Visible = false
        MinBtn.Text = "+"
    else
        Tween(MainFrame, {Size = UDim2.new(0, 300, 0, 500)})
        task.wait(0.2)
        ScrollList.Visible = true
        SettingsFrame.Visible = true
        StatusFrame.Visible = true
        MinBtn.Text = "-"
    end
end)

local StatsData = {}
do
    local sf = Instance.new("Frame")
    sf.Name = "StatsFrame"
    sf.Size = UDim2.new(0, 120, 0, 60)
    sf.Position = UDim2.new(0.5, -60, 0, 10)
    sf.BackgroundColor3 = THEME.Background
    sf.Visible = false
    sf.Parent = ScreenGui
    EnableDragging(sf)
    Instance.new("UICorner", sf).CornerRadius = UDim.new(0, 8)
    Instance.new("UIStroke", sf).Color = THEME.Accent
    StatsData.Frame = sf

    local st = Instance.new("TextLabel")
    st.Size = UDim2.new(1, 0, 0, 25)
    st.Position = UDim2.new(0, 0, 0, 5)
    st.BackgroundTransparency = 1
    st.TextColor3 = THEME.Text
    st.Font = Enum.Font.GothamBold
    st.TextSize = 20
    st.Text = "--"
    st.Parent = sf
    StatsData.Timer = st

    local sc = Instance.new("TextLabel")
    sc.Size = UDim2.new(1, 0, 0, 20)
    sc.Position = UDim2.new(0, 0, 0, 30)
    sc.BackgroundTransparency = 1
    sc.TextColor3 = THEME.SubText
    sc.Font = Enum.Font.Gotham
    sc.TextSize = 12
    sc.Text = "Kata: 0"
    sc.Parent = sf
    StatsData.Count = sc
end

-- ============================================================
-- MAIN LOOP
-- ============================================================
runConn = RunService.RenderStepped:Connect(function()
    local ok, err = pcall(function()
        if unloaded then return end
        local now = tick()

        -- Watchdog
        if isTyping and (tick() - lastTypingStart) > 15 then
            isTyping = false
            isAutoPlayScheduled = false
            StatusText.Text = "Typing Reset (Watchdog)"
            StatusText.TextColor3 = THEME.Warning
        end

        local inRound = IsInRound()
        local isMyTurn, requiredLetter = GetTurnInfo()
        local seconds = GetTimer()

        -- Timer display
        if seconds and inRound then
            StatsData.Frame.Visible = true
            StatsData.Timer.Text = string.format("%.1f", seconds)
            StatsData.Timer.TextColor3 = seconds < 3 and Color3.fromRGB(255,80,80) or THEME.Text
        else
            StatsData.Frame.Visible = false
        end

        -- Tidak dalam ronde
        if not inRound then
            if StatusText.Text ~= "Menunggu ronde..." then
                StatusText.Text = "Menunggu ronde..."
                StatusText.TextColor3 = THEME.SubText
                Tween(StatusDot, {BackgroundColor3 = THEME.SubText})
                for _, btn in ipairs(ButtonCache) do btn.Visible = false end
                StatsData.Count.Text = "Kata: 0"
            end
            lastDetected = "---"
            lastRequiredLetter = ""
            currentBestMatch = nil
            return
        end

        -- Baca kata yang diketik (sort by X)
        local detected = GetCurrentGameWord()

        -- Update status giliran
        if isMyTurn then
            if not isTyping then
                StatusText.Text = "🟢 Giliran kamu!"
                StatusText.TextColor3 = THEME.Success
                Tween(StatusDot, {BackgroundColor3 = THEME.Success})
            end
        else
            if not isTyping then
                StatusText.Text = "🔴 Menunggu giliran..."
                StatusText.TextColor3 = THEME.SubText
                Tween(StatusDot, {BackgroundColor3 = THEME.SubText})
            end
            isAutoPlayScheduled = false
        end

        -- Prefix untuk pencarian
        local searchPrefix = ""
        if isMyTurn then
            searchPrefix = #detected > 0 and detected or (requiredLetter or "")
        else
            searchPrefix = requiredLetter or ""
        end

        -- Update list jika ada perubahan
        if searchPrefix ~= lastDetected or requiredLetter ~= lastRequiredLetter or forceUpdateList then
            lastDetected = searchPrefix
            lastRequiredLetter = requiredLetter or ""
            forceUpdateList = false
            currentBestMatch = nil
            UpdateList(searchPrefix, requiredLetter)
            local visCount = 0
            for _, b in ipairs(ButtonCache) do
                if b.Visible then visCount = visCount + 1 end
            end
            StatsData.Count.Text = "Kata: " .. visCount .. "+"
        end

        -- Panic mode
        if panicMode and isMyTurn and not isTyping and seconds and seconds < 2 and currentBestMatch then
            StatusText.Text = "⚠ PANIC!"
            StatusText.TextColor3 = Color3.fromRGB(255, 50, 50)
            task.spawn(function() SmartType(currentBestMatch, detected, false, false) end)
            return
        end

        -- Auto Play (hanya saat giliran kita, tidak saat chat aktif)
        if autoPlay and isMyTurn and not isTyping and not isAutoPlayScheduled and currentBestMatch then
            local focused = UserInputService:GetFocusedTextBox()
            local matchUI = GetMatchUI()
            local notInChat = focused == nil or (matchUI and focused:IsDescendantOf(matchUI))
            if notInChat then
                isAutoPlayScheduled = true
                local targetWord = currentBestMatch
                local snapshotDetected = lastDetected
                task.spawn(function()
                    local delay = isBlatant and 0.15 or (thinkDelayCurrent * (0.8 + math.random() * 0.4))
                    task.wait(delay)
                    local stillMyTurn, _ = GetTurnInfo()
                    if autoPlay and not isTyping and stillMyTurn then
                        SmartType(targetWord, snapshotDetected, false, false)
                    end
                    isAutoPlayScheduled = false
                end)
            end
        end
    end)
end)

inputConn = UserInputService.InputBegan:Connect(function(input)
    if unloaded then return end
    if input.KeyCode == TOGGLE_KEY then ScreenGui.Enabled = not ScreenGui.Enabled end
end)

ShowToast("WordHelper Sambung Kata aktif!", "success")
print("✅ WordHelper Sambung Kata (Last Letter Edition) berhasil dimuat!")
print("📌 RightControl = sembunyikan/tampilkan GUI")
