-- =============================================
-- WORDHELPER V4 - SAMBUNG KATA
-- Fix: deteksi giliran via Word labels di WordSubmit,
--      misstype, auto clear gagal, autoplay tidak ganggu chat,
--      filter kata terlalu pendek
-- =============================================

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local cloneref = cloneref or function(o) return o end
local gethui = gethui or function() return game:GetService("CoreGui") end

local CoreGui = cloneref(game:GetService("CoreGui"))
local Players = cloneref(game:GetService("Players"))
local VirtualInputManager = cloneref(game:GetService("VirtualInputManager"))
local UserInputService = cloneref(game:GetService("UserInputService"))
local RunService = cloneref(game:GetService("RunService"))
local TweenService = cloneref(game:GetService("TweenService"))

local request = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request

math.randomseed(os.time())

-- =============================================
-- KONSTANTA & CONFIG
-- =============================================
local TOGGLE_KEY      = Enum.KeyCode.RightControl
local MIN_CPM         = 50
local MAX_CPM_LEGIT   = 1500
local MAX_CPM_BLATANT = 3000
local MIN_WORD_LENGTH = 3 -- filter kata terlalu pendek

local THEME = {
    Background = Color3.fromRGB(20, 20, 24),
    ItemBG     = Color3.fromRGB(32, 32, 38),
    Accent     = Color3.fromRGB(114, 100, 255),
    Text       = Color3.fromRGB(240, 240, 240),
    SubText    = Color3.fromRGB(150, 150, 160),
    Success    = Color3.fromRGB(100, 255, 140),
    Warning    = Color3.fromRGB(255, 200, 80),
    Slider     = Color3.fromRGB(60, 60, 70)
}

local function ColorToRGB(c)
    return string.format("%d,%d,%d", math.floor(c.R*255), math.floor(c.G*255), math.floor(c.B*255))
end

local ConfigFile = "WordHelper_SK_Config.json"
local Config = {
    CPM           = 550,
    Blatant       = false,
    Humanize      = true,
    SortMode      = "Random",
    AutoPlay      = false,
    PanicMode     = true,
    MinWordLength = 3,
}

local function SaveConfig()
    if writefile then writefile(ConfigFile, HttpService:JSONEncode(Config)) end
end

local function LoadConfig()
    if isfile and isfile(ConfigFile) then
        local ok, decoded = pcall(function() return HttpService:JSONDecode(readfile(ConfigFile)) end)
        if ok and decoded then
            for k, v in pairs(decoded) do Config[k] = v end
        end
    end
end
LoadConfig()

local currentCPM      = Config.CPM
local isBlatant       = Config.Blatant
local useHumanization = Config.Humanize
local sortMode        = Config.SortMode
local autoPlay        = Config.AutoPlay
local panicMode       = Config.PanicMode
local minWordLength   = Config.MinWordLength or 3

local isTyping            = false
local isAutoPlayScheduled = false
local lastTypingStart     = 0
local unloaded            = false
local runConn             = nil
local inputConn           = nil

local Blacklist       = {}
local UsedWords       = {}
local lastSearchPrefix= ""
local currentBestMatch= nil
local forceUpdateList = false
local ButtonCache     = {}
local ButtonData      = {}
local UpdateList      -- forward declaration

-- =============================================
-- HELPER: PATH UI SAMBUNG KATA
-- =============================================
local function GetMatchUI()
    local gui = Players.LocalPlayer and Players.LocalPlayer:FindFirstChild("PlayerGui")
    return gui and gui:FindFirstChild("MatchUI")
end

local function GetBottomUI()
    local m = GetMatchUI()
    return m and m:FindFirstChild("BottomUI")
end

local function GetTopUI()
    local b = GetBottomUI()
    return b and b:FindFirstChild("TopUI")
end

local function GetWordSubmit()
    local t = GetTopUI()
    return t and t:FindFirstChild("WordSubmit")
end

-- Ambil huruf wajib dari WordServer
local function GetRequiredLetter()
    local topUI = GetTopUI()
    local wsf = topUI and topUI:FindFirstChild("WordServerFrame")
    local ws  = wsf and wsf:FindFirstChild("WordServer")
    if ws and ws:IsA("TextLabel") then
        local txt = ws.Text:lower():gsub("[%s%c]+", "")
        if #txt > 0 then return txt end
    end
    return nil
end

-- [FIX DETEKSI GILIRAN] Cek ada/tidaknya Word label berisi teks di WordSubmit
-- Giliran kamu  â†’ ada Word label yang visible dan berisi teks
-- Giliran musuh â†’ tidak ada Word label berisi teks
local function IsMyTurn()
    local wordSubmit = GetWordSubmit()
    if not wordSubmit then return false end
    for _, v in ipairs(wordSubmit:GetChildren()) do
        if v:IsA("TextLabel") and v.Name == "Word" and v.Visible and v.Text ~= "" then
            return true
        end
    end
    return false
end

-- [FIX URUTAN] Baca kata yang sedang diketik, sort by posisi X
local function GetTypedWord()
    local wordSubmit = GetWordSubmit()
    if not wordSubmit then return "" end

    local letters = {}
    for _, v in ipairs(wordSubmit:GetChildren()) do
        if v:IsA("TextLabel") and v.Name == "Word" and v.Visible and v.Text ~= "" then
            table.insert(letters, {text = v.Text, x = v.AbsolutePosition.X})
        end
    end

    table.sort(letters, function(a, b) return a.x < b.x end)

    local result = ""
    for _, l in ipairs(letters) do result = result .. l.text end
    return result:lower()
end

-- Cek apakah sedang dalam ronde
local function IsInRound()
    local req = GetRequiredLetter()
    return req ~= nil and #req > 0
end

-- Ambil nilai timer
local function GetTimer()
    local b = GetBottomUI()
    local c  = b and b:FindFirstChild("CenterUI")
    local th = c and c:FindFirstChild("TimerHealthUI")
    local tu = th and th:FindFirstChild("TimerUI")
    local tl = tu and tu:FindFirstChild("Timer")
    if tl and tl:IsA("TextLabel") then
        return tonumber(tl.Text:match("([%d%.]+)"))
    end
    return nil
end

-- Cari TextBox input game
local function GetGameTextBox()
    local topUI = GetTopUI()
    local keyboard = topUI and topUI:FindFirstChild("Keyboard")
    if keyboard then
        for _, c in ipairs(keyboard:GetDescendants()) do
            if c:IsA("TextBox") and c.Visible then return c end
        end
    end
    local matchUI = GetMatchUI()
    if matchUI then
        for _, c in ipairs(matchUI:GetDescendants()) do
            if c:IsA("TextBox") and c.Visible then return c end
        end
    end
    return UserInputService:GetFocusedTextBox()
end

-- =============================================
-- WORD LIST LOADING
-- =============================================
local url      = "https://raw.githubusercontent.com/geovedi/indonesian-wordlist/master/01-kbbi3-2001-sort-alpha.lst"
local fileName = "ultimate_words_v4.txt"

local function GetSecureParent()
    local ok, r = pcall(function() return gethui() end)
    if ok and r then return r end
    ok, r = pcall(function() return CoreGui end)
    if ok and r then return r end
    return Players.LocalPlayer.PlayerGui
end

-- Loading UI
local LoadingGui = Instance.new("ScreenGui")
LoadingGui.Name   = "WHLoading"
LoadingGui.Parent = GetSecureParent()

local LFrame = Instance.new("Frame", LoadingGui)
LFrame.Size = UDim2.new(0, 320, 0, 90)
LFrame.Position = UDim2.new(0.5, -160, 0.4, 0)
LFrame.BackgroundColor3 = THEME.Background
LFrame.BorderSizePixel = 0
Instance.new("UICorner", LFrame).CornerRadius = UDim.new(0, 10)
Instance.new("UIStroke", LFrame).Color = THEME.Accent

local LTitle = Instance.new("TextLabel", LFrame)
LTitle.Size = UDim2.new(1, 0, 0, 40)
LTitle.BackgroundTransparency = 1
LTitle.Text = "WordHelper â€” Sambung Kata"
LTitle.TextColor3 = THEME.Accent
LTitle.Font = Enum.Font.GothamBold
LTitle.TextSize = 16

local LStatus = Instance.new("TextLabel", LFrame)
LStatus.Size = UDim2.new(1, -20, 0, 30)
LStatus.Position = UDim2.new(0, 10, 0, 45)
LStatus.BackgroundTransparency = 1
LStatus.Text = "Memuat..."
LStatus.TextColor3 = THEME.Text
LStatus.Font = Enum.Font.Gotham
LStatus.TextSize = 13

local function UpdateLoadStatus(text, color)
    LStatus.Text = text
    if color then LStatus.TextColor3 = color end
    RunService.RenderStepped:Wait()
end

UpdateLoadStatus("Mengunduh daftar kata...", THEME.Warning)
local fetchOk, fetchRes = pcall(function()
    return request({Url = url, Method = "GET"})
end)
if fetchOk and fetchRes and fetchRes.Body then
    writefile(fileName, fetchRes.Body)
    UpdateLoadStatus("Berhasil diunduh!", THEME.Success)
else
    UpdateLoadStatus("Gagal unduh, pakai cache.", Color3.fromRGB(255,80,80))
end
task.wait(0.4)

local Words    = {}
local SeenWords = {}
local Buckets  = {}

UpdateLoadStatus("Memuat daftar kata...", THEME.Warning)
if isfile and isfile(fileName) then
    local content = readfile(fileName)
    for w in content:gmatch("[^\r\n]+") do
        local clean = w:gsub("[%s%c]+",""):lower()
        if #clean >= minWordLength and not SeenWords[clean] then
            SeenWords[clean] = true
            table.insert(Words, clean)
        end
    end
    UpdateLoadStatus("Dimuat "..#Words.." kata!", THEME.Success)
else
    UpdateLoadStatus("File tidak ditemukan!", Color3.fromRGB(255,80,80))
end
task.wait(0.5)
LoadingGui:Destroy()

table.sort(Words)
for _, w in ipairs(Words) do
    local c = w:sub(1,1)
    Buckets[c] = Buckets[c] or {}
    table.insert(Buckets[c], w)
end
SeenWords = nil

-- =============================================
-- GUI UTAMA
-- =============================================
local env = (getgenv and getgenv()) or _G
if env.WordHelperInstance and env.WordHelperInstance.Parent then
    env.WordHelperInstance:Destroy()
end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name   = tostring(math.random(1000000,9999999))
ScreenGui.Parent = GetSecureParent()
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
env.WordHelperInstance = ScreenGui

local function Tween(obj, props, t)
    TweenService:Create(obj, TweenInfo.new(t or 0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), props):Play()
end

local function EnableDragging(frame)
    local dragging, dragInput, dragStart, startPos
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset+delta.X, startPos.Y.Scale, startPos.Y.Offset+delta.Y)
        end
    end)
end

-- Toast
local ToastContainer = Instance.new("Frame", ScreenGui)
ToastContainer.Size = UDim2.new(0, 280, 1, 0)
ToastContainer.Position = UDim2.new(1, -300, 0, 20)
ToastContainer.BackgroundTransparency = 1
ToastContainer.ZIndex = 100

local function ShowToast(msg, ttype)
    local toast = Instance.new("Frame", ToastContainer)
    toast.Size = UDim2.new(1, 0, 0, 40)
    toast.BackgroundColor3 = THEME.ItemBG
    toast.BackgroundTransparency = 1
    toast.BorderSizePixel = 0
    local stroke = Instance.new("UIStroke", toast)
    stroke.Thickness = 1.5
    stroke.Transparency = 1
    local col = ttype == "success" and THEME.Success
             or ttype == "warning" and THEME.Warning
             or ttype == "error"   and Color3.fromRGB(255,80,80)
             or THEME.Text
    stroke.Color = col
    Instance.new("UICorner", toast).CornerRadius = UDim.new(0,6)
    local lbl = Instance.new("TextLabel", toast)
    lbl.Size = UDim2.new(1,-20,1,0)
    lbl.Position = UDim2.new(0,10,0,0)
    lbl.BackgroundTransparency = 1
    lbl.Text = msg
    lbl.TextColor3 = col
    lbl.Font = Enum.Font.GothamMedium
    lbl.TextSize = 13
    lbl.TextWrapped = true
    lbl.TextTransparency = 1
    Tween(toast, {BackgroundTransparency=0.1}, 0.3)
    Tween(lbl,   {TextTransparency=0}, 0.3)
    Tween(stroke,{Transparency=0.2}, 0.3)
    task.delay(3, function()
        if toast and toast.Parent then
            Tween(toast, {BackgroundTransparency=1}, 0.5)
            Tween(lbl,   {TextTransparency=1}, 0.5)
            Tween(stroke,{Transparency=1}, 0.5)
            task.wait(0.5)
            toast:Destroy()
        end
    end)
end

-- Main Frame
local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 300, 0, 510)
MainFrame.Position = UDim2.new(0.78, 0, 0.3, 0)
MainFrame.BackgroundColor3 = THEME.Background
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.ClipsDescendants = true
EnableDragging(MainFrame)
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)
local MStroke = Instance.new("UIStroke", MainFrame)
MStroke.Color = THEME.Accent
MStroke.Transparency = 0.5
MStroke.Thickness = 2

-- Header
local Header = Instance.new("Frame", MainFrame)
Header.Size = UDim2.new(1, 0, 0, 45)
Header.BackgroundColor3 = THEME.ItemBG
Header.BorderSizePixel = 0

local Title = Instance.new("TextLabel", Header)
Title.Text = "Word<font color=\"rgb(114,100,255)\">Helper</font> â€” Sambung Kata"
Title.RichText = true
Title.Font = Enum.Font.GothamBold
Title.TextSize = 14
Title.TextColor3 = THEME.Text
Title.Size = UDim2.new(1, -95, 1, 0)
Title.Position = UDim2.new(0, 12, 0, 0)
Title.BackgroundTransparency = 1
Title.TextXAlignment = Enum.TextXAlignment.Left

local MinBtn = Instance.new("TextButton", Header)
MinBtn.Text = "â€”"
MinBtn.Font = Enum.Font.GothamBold
MinBtn.TextSize = 20
MinBtn.TextColor3 = THEME.SubText
MinBtn.Size = UDim2.new(0, 40, 1, 0)
MinBtn.Position = UDim2.new(1, -85, 0, 0)
MinBtn.BackgroundTransparency = 1

local CloseBtn = Instance.new("TextButton", Header)
CloseBtn.Text = "âœ•"
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.TextSize = 16
CloseBtn.TextColor3 = Color3.fromRGB(255, 80, 80)
CloseBtn.Size = UDim2.new(0, 40, 1, 0)
CloseBtn.Position = UDim2.new(1, -43, 0, 0)
CloseBtn.BackgroundTransparency = 1

CloseBtn.MouseButton1Click:Connect(function()
    unloaded = true
    if runConn then runConn:Disconnect() end
    if inputConn then inputConn:Disconnect() end
    for _, b in ipairs(ButtonCache) do b:Destroy() end
    table.clear(ButtonCache)
    if ScreenGui and ScreenGui.Parent then ScreenGui:Destroy() end
end)

local isMinimized = false
MinBtn.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    if isMinimized then
        Tween(MainFrame, {Size = UDim2.new(0, 300, 0, 45)})
        MinBtn.Text = "â–¡"
    else
        Tween(MainFrame, {Size = UDim2.new(0, 300, 0, 510)})
        MinBtn.Text = "â€”"
    end
end)

-- Status bar
local StatusFrame = Instance.new("Frame", MainFrame)
StatusFrame.Size = UDim2.new(1, -20, 0, 22)
StatusFrame.Position = UDim2.new(0, 10, 0, 52)
StatusFrame.BackgroundTransparency = 1

local StatusDot = Instance.new("Frame", StatusFrame)
StatusDot.Size = UDim2.new(0, 8, 0, 8)
StatusDot.Position = UDim2.new(0, 0, 0.5, -4)
StatusDot.BackgroundColor3 = THEME.SubText
Instance.new("UICorner", StatusDot).CornerRadius = UDim.new(1, 0)

local StatusText = Instance.new("TextLabel", StatusFrame)
StatusText.Text = "Menunggu..."
StatusText.RichText = true
StatusText.Font = Enum.Font.Gotham
StatusText.TextSize = 12
StatusText.TextColor3 = THEME.SubText
StatusText.Size = UDim2.new(1, -15, 1, 0)
StatusText.Position = UDim2.new(0, 14, 0, 0)
StatusText.BackgroundTransparency = 1
StatusText.TextXAlignment = Enum.TextXAlignment.Left

-- Info box
local InfoFrame = Instance.new("Frame", MainFrame)
InfoFrame.Size = UDim2.new(1, -20, 0, 48)
InfoFrame.Position = UDim2.new(0, 10, 0, 78)
InfoFrame.BackgroundColor3 = THEME.ItemBG
InfoFrame.BorderSizePixel = 0
Instance.new("UICorner", InfoFrame).CornerRadius = UDim.new(0, 6)

local InfoLeftLbl = Instance.new("TextLabel", InfoFrame)
InfoLeftLbl.Size = UDim2.new(0.5, 0, 0.5, 0)
InfoLeftLbl.Position = UDim2.new(0, 10, 0, 4)
InfoLeftLbl.BackgroundTransparency = 1
InfoLeftLbl.Text = "Kata diketik:"
InfoLeftLbl.TextColor3 = THEME.SubText
InfoLeftLbl.Font = Enum.Font.Gotham
InfoLeftLbl.TextSize = 11
InfoLeftLbl.TextXAlignment = Enum.TextXAlignment.Left

local InfoTyped = Instance.new("TextLabel", InfoFrame)
InfoTyped.Size = UDim2.new(0.6, 0, 0.5, 0)
InfoTyped.Position = UDim2.new(0, 10, 0.5, 0)
InfoTyped.BackgroundTransparency = 1
InfoTyped.Text = "---"
InfoTyped.TextColor3 = THEME.Success
InfoTyped.Font = Enum.Font.GothamBold
InfoTyped.TextSize = 16
InfoTyped.TextXAlignment = Enum.TextXAlignment.Left

local GiliranLabel = Instance.new("TextLabel", InfoFrame)
GiliranLabel.Size = UDim2.new(0.42, -5, 1, 0)
GiliranLabel.Position = UDim2.new(0.58, 0, 0, 0)
GiliranLabel.BackgroundTransparency = 1
GiliranLabel.Text = ""
GiliranLabel.TextColor3 = THEME.SubText
GiliranLabel.Font = Enum.Font.GothamBold
GiliranLabel.TextSize = 12
GiliranLabel.TextXAlignment = Enum.TextXAlignment.Right
GiliranLabel.TextWrapped = true

-- Search box
local SearchFrame = Instance.new("Frame", MainFrame)
SearchFrame.Size = UDim2.new(1, -20, 0, 26)
SearchFrame.Position = UDim2.new(0, 10, 0, 132)
SearchFrame.BackgroundColor3 = THEME.ItemBG
SearchFrame.BorderSizePixel = 0
Instance.new("UICorner", SearchFrame).CornerRadius = UDim.new(0, 6)

local SearchBox = Instance.new("TextBox", SearchFrame)
SearchBox.Size = UDim2.new(1, -20, 1, 0)
SearchBox.Position = UDim2.new(0, 10, 0, 0)
SearchBox.BackgroundTransparency = 1
SearchBox.Font = Enum.Font.Gotham
SearchBox.TextSize = 13
SearchBox.TextColor3 = THEME.Text
SearchBox.PlaceholderText = "Cari kata manual..."
SearchBox.PlaceholderColor3 = THEME.SubText
SearchBox.Text = ""
SearchBox.TextXAlignment = Enum.TextXAlignment.Left

SearchBox:GetPropertyChangedSignal("Text"):Connect(function()
    if UpdateList then
        local prefix = SearchBox.Text ~= "" and SearchBox.Text:lower():gsub("[%s%c]+","") or GetTypedWord()
        if #prefix == 0 then prefix = GetRequiredLetter() or "" end
        UpdateList(prefix)
    end
end)

-- Scroll list
local ScrollList = Instance.new("ScrollingFrame", MainFrame)
ScrollList.Size = UDim2.new(1, -10, 1, -280)
ScrollList.Position = UDim2.new(0, 5, 0, 163)
ScrollList.BackgroundTransparency = 1
ScrollList.ScrollBarThickness = 3
ScrollList.ScrollBarImageColor3 = THEME.Accent
ScrollList.CanvasSize = UDim2.new(0,0,0,0)
ScrollList.BorderSizePixel = 0

local UIListLayout = Instance.new("UIListLayout", ScrollList)
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 4)

-- =============================================
-- SETTINGS PANEL
-- =============================================
local SettingsFrame = Instance.new("Frame", MainFrame)
SettingsFrame.BackgroundColor3 = THEME.ItemBG
SettingsFrame.BorderSizePixel = 0
SettingsFrame.ClipsDescendants = true

local SlidersFrame = Instance.new("Frame", SettingsFrame)
SlidersFrame.Size = UDim2.new(1, 0, 0, 110)
SlidersFrame.BackgroundTransparency = 1

local TogglesFrame = Instance.new("Frame", SettingsFrame)
TogglesFrame.Size = UDim2.new(1, 0, 0, 90)
TogglesFrame.Position = UDim2.new(0, 0, 0, 110)
TogglesFrame.BackgroundTransparency = 1
TogglesFrame.Visible = false

local settingsCollapsed = true

local function UpdateLayout()
    if settingsCollapsed then
        Tween(SettingsFrame, {Size=UDim2.new(1,0,0,110), Position=UDim2.new(0,0,1,-110)})
        Tween(ScrollList,   {Size=UDim2.new(1,-10,1,-280)})
        TogglesFrame.Visible = false
    else
        Tween(SettingsFrame, {Size=UDim2.new(1,0,0,203), Position=UDim2.new(0,0,1,-203)})
        Tween(ScrollList,   {Size=UDim2.new(1,-10,1,-373)})
        task.wait(0.15)
        TogglesFrame.Visible = true
    end
end
UpdateLayout()

local ExpandBtn = Instance.new("TextButton", SlidersFrame)
ExpandBtn.Text = "â–¼  Pengaturan"
ExpandBtn.Font = Enum.Font.GothamBold
ExpandBtn.TextSize = 12
ExpandBtn.TextColor3 = THEME.Accent
ExpandBtn.BackgroundColor3 = Color3.fromRGB(35,35,42)
ExpandBtn.Size = UDim2.new(1,-10,0,26)
ExpandBtn.Position = UDim2.new(0,5,1,-30)
Instance.new("UICorner", ExpandBtn).CornerRadius = UDim.new(0,5)

ExpandBtn.MouseButton1Click:Connect(function()
    settingsCollapsed = not settingsCollapsed
    ExpandBtn.Text = settingsCollapsed and "â–¼  Pengaturan" or "â–²  Sembunyikan"
    UpdateLayout()
end)

-- CPM Slider
local CpmLabel = Instance.new("TextLabel", SlidersFrame)
CpmLabel.Size = UDim2.new(1,-20,0,16)
CpmLabel.Position = UDim2.new(0,10,0,5)
CpmLabel.BackgroundTransparency = 1
CpmLabel.Font = Enum.Font.GothamMedium
CpmLabel.TextSize = 11
CpmLabel.TextColor3 = THEME.SubText
CpmLabel.TextXAlignment = Enum.TextXAlignment.Left
CpmLabel.Text = "Kecepatan: "..currentCPM.." CPM"

local CpmBg = Instance.new("Frame", SlidersFrame)
CpmBg.Size = UDim2.new(1,-20,0,6)
CpmBg.Position = UDim2.new(0,10,0,23)
CpmBg.BackgroundColor3 = THEME.Slider
Instance.new("UICorner", CpmBg).CornerRadius = UDim.new(1,0)

local CpmFill = Instance.new("Frame", CpmBg)
CpmFill.Size = UDim2.new((currentCPM-MIN_CPM)/(MAX_CPM_LEGIT-MIN_CPM),0,1,0)
CpmFill.BackgroundColor3 = THEME.Accent
Instance.new("UICorner", CpmFill).CornerRadius = UDim.new(1,0)

local CpmBtn = Instance.new("TextButton", CpmBg)
CpmBtn.Size = UDim2.new(1,0,1,0)
CpmBtn.BackgroundTransparency = 1
CpmBtn.Text = ""

CpmBtn.MouseButton1Down:Connect(function()
    local move, rel
    local function Update()
        local mx = UserInputService:GetMouseLocation()
        local px = math.clamp(mx.X - CpmBg.AbsolutePosition.X, 0, CpmBg.AbsoluteSize.X)
        local pct = px / CpmBg.AbsoluteSize.X
        CpmFill.Size = UDim2.new(pct,0,1,0)
        local maxCPM = isBlatant and MAX_CPM_BLATANT or MAX_CPM_LEGIT
        currentCPM = math.floor(MIN_CPM + pct*(maxCPM-MIN_CPM))
        Config.CPM = currentCPM
        CpmLabel.Text = "Kecepatan: "..currentCPM.." CPM"
        Tween(CpmFill, {BackgroundColor3 = currentCPM > 900 and Color3.fromRGB(255,80,80) or THEME.Accent})
    end
    Update()
    move = RunService.RenderStepped:Connect(Update)
    rel = UserInputService.InputEnded:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 then
            if move then move:Disconnect() end
            if rel then rel:Disconnect() end
            SaveConfig()
        end
    end)
end)

-- Toggle helper
local function MakeToggleBtn(parent, pos, size, getLabel, getColor, onClick)
    local btn = Instance.new("TextButton", parent)
    btn.Font = Enum.Font.GothamMedium
    btn.TextSize = 11
    btn.BackgroundColor3 = THEME.Background
    btn.Size = size or UDim2.new(0,130,0,24)
    btn.Position = pos
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,4)
    local function Refresh()
        btn.Text = getLabel()
        btn.TextColor3 = getColor()
    end
    Refresh()
    btn.MouseButton1Click:Connect(function()
        onClick()
        Refresh()
        SaveConfig()
    end)
    return btn
end

-- Auto Play
MakeToggleBtn(TogglesFrame, UDim2.new(0,5,0,5), UDim2.new(0,130,0,24),
    function() return "Auto Play: "..(autoPlay and "ON" or "OFF") end,
    function() return autoPlay and THEME.Success or Color3.fromRGB(180,80,80) end,
    function() autoPlay = not autoPlay; Config.AutoPlay = autoPlay end)

-- Humanize
MakeToggleBtn(TogglesFrame, UDim2.new(0,140,0,5), UDim2.new(0,130,0,24),
    function() return "Humanize: "..(useHumanization and "ON" or "OFF") end,
    function() return useHumanization and THEME.Success or Color3.fromRGB(180,80,80) end,
    function() useHumanization = not useHumanization; Config.Humanize = useHumanization end)

-- Blatant
MakeToggleBtn(TogglesFrame, UDim2.new(0,5,0,33), UDim2.new(0,130,0,24),
    function() return "Blatant: "..(isBlatant and "ON" or "OFF") end,
    function() return isBlatant and Color3.fromRGB(255,80,80) or THEME.SubText end,
    function() isBlatant = not isBlatant; Config.Blatant = isBlatant end)

-- Sort
MakeToggleBtn(TogglesFrame, UDim2.new(0,140,0,33), UDim2.new(0,130,0,24),
    function() return "Sort: "..sortMode end,
    function() return THEME.Accent end,
    function()
        if sortMode == "Random" then sortMode = "Shortest"
        elseif sortMode == "Shortest" then sortMode = "Longest"
        elseif sortMode == "Longest" then sortMode = "Killer"
        else sortMode = "Random" end
        Config.SortMode = sortMode
        UpdateList(lastSearchPrefix)
    end)

-- Panic
MakeToggleBtn(TogglesFrame, UDim2.new(0,5,0,61), UDim2.new(0,130,0,24),
    function() return "Panic: "..(panicMode and "ON" or "OFF") end,
    function() return panicMode and THEME.Warning or THEME.SubText end,
    function() panicMode = not panicMode; Config.PanicMode = panicMode end)

-- Min Word Length
MakeToggleBtn(TogglesFrame, UDim2.new(0,140,0,61), UDim2.new(0,130,0,24),
    function() return "Min Huruf: "..minWordLength end,
    function() return THEME.Accent end,
    function()
        minWordLength = minWordLength >= 6 and 3 or minWordLength + 1
        Config.MinWordLength = minWordLength
        UpdateList(lastSearchPrefix)
    end)

-- Stats mini frame
local StatsFrame = Instance.new("Frame", ScreenGui)
StatsFrame.Size = UDim2.new(0,110,0,55)
StatsFrame.Position = UDim2.new(0.5,-55,0,10)
StatsFrame.BackgroundColor3 = THEME.Background
StatsFrame.Visible = false
EnableDragging(StatsFrame)
Instance.new("UICorner", StatsFrame).CornerRadius = UDim.new(0,8)
local SSt = Instance.new("UIStroke", StatsFrame)
SSt.Color = THEME.Accent
SSt.Thickness = 1.5

local TimerLabel = Instance.new("TextLabel", StatsFrame)
TimerLabel.Size = UDim2.new(1,0,0,28)
TimerLabel.Position = UDim2.new(0,0,0,4)
TimerLabel.BackgroundTransparency = 1
TimerLabel.TextColor3 = THEME.Text
TimerLabel.Font = Enum.Font.GothamBold
TimerLabel.TextSize = 22
TimerLabel.Text = "--"

local WordCountLabel = Instance.new("TextLabel", StatsFrame)
WordCountLabel.Size = UDim2.new(1,0,0,18)
WordCountLabel.Position = UDim2.new(0,0,0,32)
WordCountLabel.BackgroundTransparency = 1
WordCountLabel.TextColor3 = THEME.SubText
WordCountLabel.Font = Enum.Font.Gotham
WordCountLabel.TextSize = 11
WordCountLabel.Text = "Kata: 0"

-- =============================================
-- TYPING ENGINE
-- =============================================
local lastKey = nil

local function CalculateDelay()
    local base = 60 / currentCPM
    if isBlatant then return base end
    if useHumanization then
        local variance = base * 0.3
        local r = (math.random()+math.random()+math.random())/3
        return math.max(0.01, base + (r*2-1)*variance)
    end
    return base
end

-- [FIX MISSTYPE] Pakai SendTextInput saja, lebih reliable
local function SimulateKey(ch)
    if type(ch) == "string" and #ch == 1 then
        -- Coba SendTextInput dulu (paling reliable untuk karakter)
        local ok = pcall(function()
            VirtualInputManager:SendTextInput(ch)
        end)
        if not ok then
            -- Fallback ke KeyCode
            local key
            pcall(function() key = Enum.KeyCode[ch:upper()] end)
            if key then
                pcall(function()
                    VirtualInputManager:SendKeyEvent(true, key, false, game)
                    task.wait(0.015)
                    VirtualInputManager:SendKeyEvent(false, key, false, game)
                end)
            end
        end
        return
    end
    -- Untuk KeyCode langsung (Enter, Backspace)
    local key = typeof(ch) == "EnumItem" and ch or nil
    if key then
        pcall(function()
            VirtualInputManager:SendKeyEvent(true, key, false, game)
            task.wait(0.015)
            VirtualInputManager:SendKeyEvent(false, key, false, game)
        end)
    end
end

local function Backspace(count)
    for i = 1, count do
        pcall(function()
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Backspace, false, game)
            task.wait(0.012)
            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Backspace, false, game)
        end)
        if i % 10 == 0 then task.wait(0.02) end
    end
end

local function PressEnter()
    pcall(function()
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
        task.wait(0.015)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
    end)
end

-- [FIX AUTO CLEAR] Hapus sisa kata di kotak setelah gagal/salah
local function ClearTypedWord()
    local typed = GetTypedWord()
    if #typed > 0 then
        Backspace(#typed + 3)
        task.wait(0.1)
    end
end

-- =============================================
-- [FIX UTAMA] SmartType
-- - Cek giliran via IsMyTurn() (Word labels)
-- - Lanjut dari yang sudah diketik
-- - [FIX] Tidak ngetik kalau user sedang fokus di chat
-- =============================================
local function SmartType(targetWord, bypassTurn)
    if unloaded then return end
    if not bypassTurn and not IsMyTurn() then return end

    -- [FIX] Cek apakah user sedang di chat/textbox lain
    local focused = UserInputService:GetFocusedTextBox()
    if focused and not focused:IsDescendantOf(GetMatchUI() or game) then
        return -- user lagi ngetik di tempat lain (misal chat), skip
    end

    if isTyping then
        if (tick() - lastTypingStart) > 15 then
            isTyping = false
            isAutoPlayScheduled = false
        else
            return
        end
    end

    -- Filter panjang minimum
    if #targetWord < minWordLength then return end

    isTyping = true
    lastTypingStart = tick()
    lastKey = nil

    local tb = GetGameTextBox()
    if tb then
        tb:CaptureFocus()
        task.wait(0.1)
    end

    StatusText.Text = "âŒ¨ Mengetik: " .. targetWord
    StatusText.TextColor3 = THEME.Accent
    Tween(StatusDot, {BackgroundColor3=THEME.Accent})

    local ok, err = pcall(function()
        -- Baca yang sudah diketik, lanjut dari sana
        local alreadyTyped = GetTypedWord()
        local toType = ""

        if #alreadyTyped > 0 and targetWord:sub(1, #alreadyTyped):lower() == alreadyTyped:lower() then
            toType = targetWord:sub(#alreadyTyped + 1)
        else
            -- Kotak punya konten berbeda, hapus dulu
            if #alreadyTyped > 0 then
                Backspace(#alreadyTyped + 3)
                task.wait(0.15)
            end
            toType = targetWord
        end

        -- Ketik sisa huruf
        for i = 1, #toType do
            -- Cek giliran tiap huruf
            if not bypassTurn and not IsMyTurn() then
                ClearTypedWord()
                StatusText.Text = "Giliran habis, dibatalkan"
                StatusText.TextColor3 = THEME.Warning
                isTyping = false
                isAutoPlayScheduled = false
                return
            end

            -- [FIX] Cek chat â€” batalkan kalau user mulai ngetik di chat
            local foc = UserInputService:GetFocusedTextBox()
            if foc and not foc:IsDescendantOf(GetMatchUI() or game) then
                ClearTypedWord()
                StatusText.Text = "Dibatalkan (chat aktif)"
                StatusText.TextColor3 = THEME.Warning
                isTyping = false
                isAutoPlayScheduled = false
                return
            end

            local ch = toType:sub(i, i)
            SimulateKey(ch)
            -- [FIX MISSTYPE] Delay yang lebih konsisten, tidak terlalu cepat
            local delay = CalculateDelay()
            task.wait(math.max(delay, 0.03)) -- minimum 0.03s antar huruf
            lastKey = ch

            if useHumanization and math.random() < 0.04 then
                task.wait(0.08 + math.random() * 0.2)
            end
        end

        task.wait(0.1)

        if bypassTurn or IsMyTurn() then
            PressEnter()
            UsedWords[targetWord] = true
            StatusText.Text = "âœ“ Terkirim: " .. targetWord
            StatusText.TextColor3 = THEME.Success
            Tween(StatusDot, {BackgroundColor3=THEME.Success})
        else
            ClearTypedWord()
            StatusText.Text = "Giliran habis sebelum enter"
            StatusText.TextColor3 = THEME.Warning
        end
    end)

    if not ok then
        -- [FIX AUTO CLEAR] Kalau error, bersihkan kotak
        pcall(ClearTypedWord)
        StatusText.Text = "Error, kotak dibersihkan"
        StatusText.TextColor3 = Color3.fromRGB(255,80,80)
    end

    isTyping = false
    isAutoPlayScheduled = false
    forceUpdateList = true
    lastKey = nil
end

-- =============================================
-- UPDATE LIST KATA
-- =============================================
local function shuffleTable(t)
    for i = #t, 2, -1 do
        local j = math.random(i)
        t[i], t[j] = t[j], t[i]
    end
end

local HardLetterScores = {x=10,z=9,q=9,j=8,v=6,k=5,b=4,f=3,w=3,y=2,g=2,p=2}
local function KillerScore(w) return HardLetterScores[w:sub(-1)] or 0 end

local function BinarySearchStart(list, prefix)
    local l, r, res = 1, #list, -1
    local pLen = #prefix
    while l <= r do
        local mid = math.floor((l+r)/2)
        local sub = list[mid]:sub(1,pLen)
        if sub == prefix then res = mid; r = mid-1
        elseif sub < prefix then l = mid+1
        else r = mid-1
        end
    end
    return res
end

UpdateList = function(prefix)
    prefix = (prefix or ""):lower():gsub("[%s%c]+","")
    lastSearchPrefix = prefix

    if #prefix == 0 then
        for _, btn in ipairs(ButtonCache) do btn.Visible = false end
        currentBestMatch = nil
        ScrollList.CanvasSize = UDim2.new(0,0,0,0)
        WordCountLabel.Text = "Kata: 0"
        return
    end

    local firstChar = prefix:sub(1,1)
    local bucket = (Buckets and Buckets[firstChar]) or Words
    local matches = {}

    if bucket and #bucket > 0 then
        local startIdx = BinarySearchStart(bucket, prefix)
        if startIdx ~= -1 then
            for i = startIdx, #bucket do
                local w = bucket[i]
                if w:sub(1, #prefix) ~= prefix then break end
                if not Blacklist[w] and not UsedWords[w] and #w >= minWordLength then
                    table.insert(matches, w)
                    if #matches >= 120 then break end
                end
            end
        end
    end

    if sortMode == "Random" then
        shuffleTable(matches)
    elseif sortMode == "Longest" then
        table.sort(matches, function(a,b) return #a > #b end)
    elseif sortMode == "Shortest" then
        table.sort(matches, function(a,b) return #a < #b end)
    elseif sortMode == "Killer" then
        table.sort(matches, function(a,b)
            local sa, sb = KillerScore(a), KillerScore(b)
            if sa == sb then return #a < #b end
            return sa > sb
        end)
    end

    currentBestMatch = #matches > 0 and matches[1] or nil

    local displayList = {}
    for i = 1, math.min(40, #matches) do displayList[i] = matches[i] end

    for i = 1, math.max(#displayList, #ButtonCache) do
        local w = displayList[i]
        local btn = ButtonCache[i]

        if w then
            local lbl
            if not btn then
                btn = Instance.new("TextButton")
                btn.Size = UDim2.new(1,-6,0,30)
                btn.BackgroundColor3 = THEME.ItemBG
                btn.Text = ""
                btn.AutoButtonColor = false
                btn.BorderSizePixel = 0
                Instance.new("UICorner", btn).CornerRadius = UDim.new(0,6)

                lbl = Instance.new("TextLabel", btn)
                lbl.Name = "Label"
                lbl.Size = UDim2.new(1,-16,1,0)
                lbl.Position = UDim2.new(0,8,0,0)
                lbl.BackgroundTransparency = 1
                lbl.Font = Enum.Font.GothamMedium
                lbl.TextSize = 13
                lbl.TextXAlignment = Enum.TextXAlignment.Left
                lbl.RichText = true

                btn.MouseEnter:Connect(function() Tween(btn, {BackgroundColor3=Color3.fromRGB(45,45,55)}) end)
                btn.MouseLeave:Connect(function() Tween(btn, {BackgroundColor3=THEME.ItemBG}) end)

                btn.MouseButton1Click:Connect(function()
                    local d = ButtonData[btn]
                    if d then
                        task.spawn(function() SmartType(d.word, true) end)
                        Tween(btn, {BackgroundColor3=Color3.fromRGB(30,55,35)})
                    end
                end)

                btn.Parent = ScrollList
                table.insert(ButtonCache, btn)
            else
                lbl = btn:FindFirstChild("Label")
                btn.Visible = true
                btn.BackgroundColor3 = THEME.ItemBG
            end

            ButtonData[btn] = {word = w}

            local accentRGB = i == 1 and "100,255,140"
                           or i == 2 and "255,180,100"
                           or i == 3 and "100,180,255"
                           or ColorToRGB(THEME.Accent)
            local textRGB = ColorToRGB(THEME.Text)
            local pfx = w:sub(1, #prefix)
            local sfx = w:sub(#prefix+1)
            if lbl then
                lbl.Text = "<font color=\"rgb("..accentRGB..")\">"..pfx.."</font>"
                        .."<font color=\"rgb("..textRGB..")\">"..sfx.."</font>"
            end
        else
            if btn then
                btn.Visible = false
                ButtonData[btn] = nil
            end
        end
    end

    ScrollList.CanvasSize = UDim2.new(0,0,0, UIListLayout.AbsoluteContentSize.Y)
    WordCountLabel.Text = "Kata: "..#matches
end

-- =============================================
-- MAIN LOOP
-- =============================================
local lastPrefix = ""

runConn = RunService.RenderStepped:Connect(function()
    if unloaded then return end

    pcall(function()
        -- Watchdog
        if isTyping and (tick()-lastTypingStart) > 15 then
            isTyping = false
            isAutoPlayScheduled = false
        end

        local inRound   = IsInRound()
        local myTurn    = IsMyTurn()
        local reqLetter = GetRequiredLetter()
        local seconds   = GetTimer()

        -- Timer
        if seconds and inRound then
            StatsFrame.Visible = true
            TimerLabel.Text = string.format("%.1f", seconds)
            TimerLabel.TextColor3 = seconds < 3 and Color3.fromRGB(255,80,80) or THEME.Text
        else
            StatsFrame.Visible = false
        end

        if not inRound then
            if StatusText.Text ~= "Menunggu ronde..." then
                StatusText.Text = "Menunggu ronde..."
                StatusText.TextColor3 = THEME.SubText
                Tween(StatusDot, {BackgroundColor3=THEME.SubText})
                InfoTyped.Text = "---"
                GiliranLabel.Text = ""
                for _, b in ipairs(ButtonCache) do b.Visible = false end
                WordCountLabel.Text = "Kata: 0"
            end
            lastPrefix = ""
            currentBestMatch = nil
            return
        end

        local typedWord = GetTypedWord()

        -- Prefix pencarian
        local searchPrefix = ""
        if myTurn then
            searchPrefix = #typedWord > 0 and typedWord or (reqLetter or "")
        else
            searchPrefix = reqLetter or ""
        end

        -- Update info box
        InfoTyped.Text = #typedWord > 0 and typedWord:upper() or (reqLetter or "---"):upper()

        if myTurn then
            InfoTyped.TextColor3 = THEME.Success
            GiliranLabel.Text = "ðŸŸ¢ Giliran\nKAMU!"
            GiliranLabel.TextColor3 = THEME.Success
            Tween(StatusDot, {BackgroundColor3=THEME.Success})
            if not isTyping then
                StatusText.Text = "Giliran kamu! Ketik atau pilih kata"
                StatusText.TextColor3 = THEME.Success
            end
        else
            InfoTyped.TextColor3 = THEME.SubText
            GiliranLabel.Text = "ðŸ”´ Giliran\nlawan..."
            GiliranLabel.TextColor3 = Color3.fromRGB(180,80,80)
            Tween(StatusDot, {BackgroundColor3=THEME.SubText})
            if not isTyping then
                StatusText.Text = "Menunggu giliran..."
                StatusText.TextColor3 = THEME.SubText
            end
            isAutoPlayScheduled = false
        end

        -- Update list
        if searchPrefix ~= lastPrefix or forceUpdateList then
            lastPrefix = searchPrefix
            forceUpdateList = false
            UpdateList(searchPrefix)
        end

        -- Panic
        if myTurn and panicMode and not isTyping and seconds and seconds < 2 and currentBestMatch then
            task.spawn(function() SmartType(currentBestMatch, false) end)
            return
        end

        -- [FIX] Auto Play â€” tidak jalan kalau user sedang di chat
        if autoPlay and myTurn and not isTyping and not isAutoPlayScheduled and currentBestMatch then
            -- Cek user tidak sedang di textbox lain (chat)
            local focused = UserInputService:GetFocusedTextBox()
            local inGameBox = focused and focused:IsDescendantOf(GetMatchUI() or game)
            local notFocused = focused == nil

            if notFocused or inGameBox then
                isAutoPlayScheduled = true
                local targetWord = currentBestMatch
                task.spawn(function()
                    local delay = isBlatant and 0.1 or (0.35 + math.random()*0.5)
                    task.wait(delay)
                    -- Cek ulang sebelum ngetik
                    local foc = UserInputService:GetFocusedTextBox()
                    local stillOk = foc == nil or foc:IsDescendantOf(GetMatchUI() or game)
                    if autoPlay and not isTyping and IsMyTurn() and stillOk then
                        SmartType(targetWord, false)
                    end
                    isAutoPlayScheduled = false
                end)
            end
        end
    end)
end)

inputConn = UserInputService.InputBegan:Connect(function(input)
    if unloaded then return end
    if input.KeyCode == TOGGLE_KEY then
        ScreenGui.Enabled = not ScreenGui.Enabled
    end
end)

print("âœ… WordHelper Sambung Kata v4 berhasil dimuat!")
print("ðŸ“Œ RightControl = sembunyikan/tampilkan GUI")
ShowToast("WordHelper v4 aktif!", "success")
